import{_ as s,o as n,c as a,Q as p}from"./chunks/framework.c6d1d410.js";const u=JSON.parse('{"title":"函数绑定","description":"","frontmatter":{},"headers":[],"relativePath":"zh/guide/function-binding.md","filePath":"zh/guide/function-binding.md","lastUpdated":1698230210000}'),l={name:"zh/guide/function-binding.md"},o=p(`<h1 id="函数绑定" tabindex="-1">函数绑定 <a class="header-anchor" href="#函数绑定" aria-label="Permalink to &quot;函数绑定&quot;">​</a></h1><h2 id="参数处理" tabindex="-1">参数处理 <a class="header-anchor" href="#参数处理" aria-label="Permalink to &quot;参数处理&quot;">​</a></h2><p>假设需要编写一个 C 函数来连接两个 JavaScript 字符串：</p><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">export</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">declare</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">concatString</span><span style="color:#E1E4E8;"> (</span><span style="color:#FFAB70;">str1</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">string</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">str2</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">string</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">string</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">export</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">declare</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">function</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">concatString</span><span style="color:#24292E;"> (</span><span style="color:#E36209;">str1</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">string</span><span style="color:#24292E;">, </span><span style="color:#E36209;">str2</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">string</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">string</span></span></code></pre></div><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">Module.</span><span style="color:#B392F0;">onRuntimeInitialized</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;"> () {</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">result</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> Module.emnapiExports.</span><span style="color:#B392F0;">concatString</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;Hello &#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;世界&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(result) </span><span style="color:#6A737D;">// &#39;Hello 世界&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">Module.</span><span style="color:#6F42C1;">onRuntimeInitialized</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">function</span><span style="color:#24292E;"> () {</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">result</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> Module.emnapiExports.</span><span style="color:#6F42C1;">concatString</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;Hello &#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;世界&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">  console.</span><span style="color:#6F42C1;">log</span><span style="color:#24292E;">(result) </span><span style="color:#6A737D;">// &#39;Hello 世界&#39;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h3 id="node-api-实现" tabindex="-1">Node-API 实现 <a class="header-anchor" href="#node-api-实现" aria-label="Permalink to &quot;Node-API 实现&quot;">​</a></h3><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">#include</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&lt;node_api.h&gt;</span></span>
<span class="line"><span style="color:#F97583;">#include</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&lt;string.h&gt;</span></span>
<span class="line"><span style="color:#F97583;">#include</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&lt;stdlib.h&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">#define</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">NAPI_CALL</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">env</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">the_call</span><span style="color:#E1E4E8;">)</span><span style="color:#6A737D;"> /* ... */</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> napi_value </span><span style="color:#B392F0;">js_concat_string</span><span style="color:#E1E4E8;">(napi_env </span><span style="color:#FFAB70;">env</span><span style="color:#E1E4E8;">, napi_callback_info </span><span style="color:#FFAB70;">info</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">size_t</span><span style="color:#E1E4E8;"> argc </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  napi_value </span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">];</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">NAPI_CALL</span><span style="color:#E1E4E8;">(env, </span><span style="color:#B392F0;">napi_get_cb_info</span><span style="color:#E1E4E8;">(env, info, </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">argc, args, </span><span style="color:#79B8FF;">NULL</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">NULL</span><span style="color:#E1E4E8;">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (argc </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">napi_throw_type_error</span><span style="color:#E1E4E8;">(env, </span><span style="color:#79B8FF;">NULL</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;Wrong number of arguments&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">NULL</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  napi_valuetype valuetype0, valuetype1;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">NAPI_CALL</span><span style="color:#E1E4E8;">(env, </span><span style="color:#B392F0;">napi_typeof</span><span style="color:#E1E4E8;">(env, </span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">], </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">valuetype0));</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">NAPI_CALL</span><span style="color:#E1E4E8;">(env, </span><span style="color:#B392F0;">napi_typeof</span><span style="color:#E1E4E8;">(env, </span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">], </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">valuetype1));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (valuetype0 </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> napi_string </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> valuetype1 </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> napi_string) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">napi_throw_type_error</span><span style="color:#E1E4E8;">(env, </span><span style="color:#79B8FF;">NULL</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;Wrong arguments&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">NULL</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">size_t</span><span style="color:#E1E4E8;"> len1 </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">size_t</span><span style="color:#E1E4E8;"> len2 </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">NAPI_CALL</span><span style="color:#E1E4E8;">(env, </span><span style="color:#B392F0;">napi_get_value_string_utf8</span><span style="color:#E1E4E8;">(env, </span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">], </span><span style="color:#79B8FF;">NULL</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">len1));</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">NAPI_CALL</span><span style="color:#E1E4E8;">(env, </span><span style="color:#B392F0;">napi_get_value_string_utf8</span><span style="color:#E1E4E8;">(env, </span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">], </span><span style="color:#79B8FF;">NULL</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">len2));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">size_t</span><span style="color:#E1E4E8;"> total_buffer_size </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> len1 </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> len2 </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">char*</span><span style="color:#E1E4E8;"> str </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">char*</span><span style="color:#E1E4E8;">) </span><span style="color:#B392F0;">malloc</span><span style="color:#E1E4E8;">(total_buffer_size);</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (str </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">NULL</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">napi_throw_error</span><span style="color:#E1E4E8;">(env, </span><span style="color:#79B8FF;">NULL</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;malloc failed&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">NULL</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  napi_status status </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">napi_get_value_string_utf8</span><span style="color:#E1E4E8;">(env, </span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">],</span></span>
<span class="line"><span style="color:#E1E4E8;">                                                  str, total_buffer_size, </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">len1);</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (status </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> napi_ok) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">free</span><span style="color:#E1E4E8;">(str);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">NAPI_CALL</span><span style="color:#E1E4E8;">(env, status);</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  status </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">napi_get_value_string_utf8</span><span style="color:#E1E4E8;">(env, </span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">],</span></span>
<span class="line"><span style="color:#E1E4E8;">                                      str </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> len1, total_buffer_size </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> len1, </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">len2);</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (status </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> napi_ok) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">free</span><span style="color:#E1E4E8;">(str);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">NAPI_CALL</span><span style="color:#E1E4E8;">(env, status);</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">(str </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> len1 </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> len2) </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;</span><span style="color:#79B8FF;">\\0</span><span style="color:#9ECBFF;">&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  napi_value ret;</span></span>
<span class="line"><span style="color:#E1E4E8;">  status </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">napi_create_string_utf8</span><span style="color:#E1E4E8;">(env, str, len1 </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> len2, </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">ret);</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">free</span><span style="color:#E1E4E8;">(str);</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">NAPI_CALL</span><span style="color:#E1E4E8;">(env, status);</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> ret;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">NAPI_MODULE_INIT</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">  napi_value concat_string_fn;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">NAPI_CALL</span><span style="color:#E1E4E8;">(env, </span><span style="color:#B392F0;">napi_create_function</span><span style="color:#E1E4E8;">(env, </span><span style="color:#9ECBFF;">&quot;concatString&quot;</span><span style="color:#E1E4E8;">, NAPI_AUTO_LENGTH,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                      js_concat_string, </span><span style="color:#79B8FF;">NULL</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">concat_string_fn));</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">NAPI_CALL</span><span style="color:#E1E4E8;">(env, </span><span style="color:#B392F0;">napi_set_named_property</span><span style="color:#E1E4E8;">(env, exports,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                         </span><span style="color:#9ECBFF;">&quot;concatString&quot;</span><span style="color:#E1E4E8;">, concat_string_fn));</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> exports;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">#include</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&lt;node_api.h&gt;</span></span>
<span class="line"><span style="color:#D73A49;">#include</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&lt;string.h&gt;</span></span>
<span class="line"><span style="color:#D73A49;">#include</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&lt;stdlib.h&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">#define</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">NAPI_CALL</span><span style="color:#24292E;">(</span><span style="color:#E36209;">env</span><span style="color:#24292E;">, </span><span style="color:#E36209;">the_call</span><span style="color:#24292E;">)</span><span style="color:#6A737D;"> /* ... */</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">static</span><span style="color:#24292E;"> napi_value </span><span style="color:#6F42C1;">js_concat_string</span><span style="color:#24292E;">(napi_env </span><span style="color:#E36209;">env</span><span style="color:#24292E;">, napi_callback_info </span><span style="color:#E36209;">info</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">size_t</span><span style="color:#24292E;"> argc </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  napi_value </span><span style="color:#E36209;">args</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">];</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">NAPI_CALL</span><span style="color:#24292E;">(env, </span><span style="color:#6F42C1;">napi_get_cb_info</span><span style="color:#24292E;">(env, info, </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">argc, args, </span><span style="color:#005CC5;">NULL</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">NULL</span><span style="color:#24292E;">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (argc </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">napi_throw_type_error</span><span style="color:#24292E;">(env, </span><span style="color:#005CC5;">NULL</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;Wrong number of arguments&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">NULL</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  napi_valuetype valuetype0, valuetype1;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">NAPI_CALL</span><span style="color:#24292E;">(env, </span><span style="color:#6F42C1;">napi_typeof</span><span style="color:#24292E;">(env, </span><span style="color:#E36209;">args</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">], </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">valuetype0));</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">NAPI_CALL</span><span style="color:#24292E;">(env, </span><span style="color:#6F42C1;">napi_typeof</span><span style="color:#24292E;">(env, </span><span style="color:#E36209;">args</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">], </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">valuetype1));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (valuetype0 </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> napi_string </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> valuetype1 </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> napi_string) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">napi_throw_type_error</span><span style="color:#24292E;">(env, </span><span style="color:#005CC5;">NULL</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;Wrong arguments&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">NULL</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">size_t</span><span style="color:#24292E;"> len1 </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">size_t</span><span style="color:#24292E;"> len2 </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">NAPI_CALL</span><span style="color:#24292E;">(env, </span><span style="color:#6F42C1;">napi_get_value_string_utf8</span><span style="color:#24292E;">(env, </span><span style="color:#E36209;">args</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">], </span><span style="color:#005CC5;">NULL</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">len1));</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">NAPI_CALL</span><span style="color:#24292E;">(env, </span><span style="color:#6F42C1;">napi_get_value_string_utf8</span><span style="color:#24292E;">(env, </span><span style="color:#E36209;">args</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">], </span><span style="color:#005CC5;">NULL</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">len2));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">size_t</span><span style="color:#24292E;"> total_buffer_size </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> len1 </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> len2 </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">char*</span><span style="color:#24292E;"> str </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">char*</span><span style="color:#24292E;">) </span><span style="color:#6F42C1;">malloc</span><span style="color:#24292E;">(total_buffer_size);</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (str </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">NULL</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">napi_throw_error</span><span style="color:#24292E;">(env, </span><span style="color:#005CC5;">NULL</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;malloc failed&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">NULL</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">  napi_status status </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">napi_get_value_string_utf8</span><span style="color:#24292E;">(env, </span><span style="color:#E36209;">args</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">],</span></span>
<span class="line"><span style="color:#24292E;">                                                  str, total_buffer_size, </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">len1);</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (status </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> napi_ok) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">free</span><span style="color:#24292E;">(str);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">NAPI_CALL</span><span style="color:#24292E;">(env, status);</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">  status </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">napi_get_value_string_utf8</span><span style="color:#24292E;">(env, </span><span style="color:#E36209;">args</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">],</span></span>
<span class="line"><span style="color:#24292E;">                                      str </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> len1, total_buffer_size </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> len1, </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">len2);</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (status </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> napi_ok) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">free</span><span style="color:#24292E;">(str);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">NAPI_CALL</span><span style="color:#24292E;">(env, status);</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">*</span><span style="color:#24292E;">(str </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> len1 </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> len2) </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;</span><span style="color:#005CC5;">\\0</span><span style="color:#032F62;">&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  napi_value ret;</span></span>
<span class="line"><span style="color:#24292E;">  status </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">napi_create_string_utf8</span><span style="color:#24292E;">(env, str, len1 </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> len2, </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">ret);</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">free</span><span style="color:#24292E;">(str);</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">NAPI_CALL</span><span style="color:#24292E;">(env, status);</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> ret;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">NAPI_MODULE_INIT</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">  napi_value concat_string_fn;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">NAPI_CALL</span><span style="color:#24292E;">(env, </span><span style="color:#6F42C1;">napi_create_function</span><span style="color:#24292E;">(env, </span><span style="color:#032F62;">&quot;concatString&quot;</span><span style="color:#24292E;">, NAPI_AUTO_LENGTH,</span></span>
<span class="line"><span style="color:#24292E;">                                      js_concat_string, </span><span style="color:#005CC5;">NULL</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">concat_string_fn));</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">NAPI_CALL</span><span style="color:#24292E;">(env, </span><span style="color:#6F42C1;">napi_set_named_property</span><span style="color:#24292E;">(env, exports,</span></span>
<span class="line"><span style="color:#24292E;">                                         </span><span style="color:#032F62;">&quot;concatString&quot;</span><span style="color:#24292E;">, concat_string_fn));</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> exports;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h3 id="node-addon-api-实现" tabindex="-1">node-addon-api 实现 <a class="header-anchor" href="#node-addon-api-实现" aria-label="Permalink to &quot;node-addon-api 实现&quot;">​</a></h3><div class="warning custom-block"><p class="custom-block-title">WARNING</p><p>如果运行时不支持 <code>FinalizationRegistry</code> 和 <code>WeakRef</code>则<strong>不能</strong>使用 node-addon-api。</p></div><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">#include</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&lt;napi.h&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">Value</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">JsConcatString</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">CallbackInfo</span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;"> </span><span style="color:#FFAB70;">info</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::Env env </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> info.</span><span style="color:#B392F0;">Env</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (info.</span><span style="color:#B392F0;">Length</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::TypeError e </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">TypeError</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">New</span><span style="color:#E1E4E8;">(env, </span><span style="color:#9ECBFF;">&quot;Wrong number of arguments&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">NAPI_THROW</span><span style="color:#E1E4E8;">(e, </span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">Value</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">info[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">].</span><span style="color:#B392F0;">IsString</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">info[</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">].</span><span style="color:#B392F0;">IsString</span><span style="color:#E1E4E8;">()) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::TypeError e </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">TypeError</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">New</span><span style="color:#E1E4E8;">(env, </span><span style="color:#9ECBFF;">&quot;Wrong arguments&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">NAPI_THROW</span><span style="color:#E1E4E8;">(e, </span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">Value</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">std</span><span style="color:#E1E4E8;">::string str1 </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> info[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">].As</span><span style="color:#F97583;">&lt;</span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::String</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">().</span><span style="color:#B392F0;">Utf8Value</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">std</span><span style="color:#E1E4E8;">::string str2 </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> info[</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">].As</span><span style="color:#F97583;">&lt;</span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::String</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">().</span><span style="color:#B392F0;">Utf8Value</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">std</span><span style="color:#E1E4E8;">::string result </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> str1 </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> str2;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">String</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">New</span><span style="color:#E1E4E8;">(env, result);</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">Object</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Init</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">Env</span><span style="color:#E1E4E8;"> </span><span style="color:#FFAB70;">env</span><span style="color:#E1E4E8;">, </span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">Object</span><span style="color:#E1E4E8;"> </span><span style="color:#FFAB70;">exports</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">  exports.</span><span style="color:#B392F0;">Set</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">String</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">New</span><span style="color:#E1E4E8;">(env, </span><span style="color:#9ECBFF;">&quot;concatString&quot;</span><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">Function</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">New</span><span style="color:#E1E4E8;">(env, JsConcatString, </span><span style="color:#9ECBFF;">&quot;concatString&quot;</span><span style="color:#E1E4E8;">));</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> exports;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">NODE_API_MODULE</span><span style="color:#E1E4E8;">(NODE_GYP_MODULE_NAME, Init)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">#include</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&lt;napi.h&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">Value</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">JsConcatString</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">CallbackInfo</span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;"> </span><span style="color:#E36209;">info</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::Env env </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> info.</span><span style="color:#6F42C1;">Env</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (info.</span><span style="color:#6F42C1;">Length</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::TypeError e </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">TypeError</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">New</span><span style="color:#24292E;">(env, </span><span style="color:#032F62;">&quot;Wrong number of arguments&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">NAPI_THROW</span><span style="color:#24292E;">(e, </span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">Value</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">!</span><span style="color:#24292E;">info[</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">].</span><span style="color:#6F42C1;">IsString</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">!</span><span style="color:#24292E;">info[</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">].</span><span style="color:#6F42C1;">IsString</span><span style="color:#24292E;">()) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::TypeError e </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">TypeError</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">New</span><span style="color:#24292E;">(env, </span><span style="color:#032F62;">&quot;Wrong arguments&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">NAPI_THROW</span><span style="color:#24292E;">(e, </span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">Value</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">std</span><span style="color:#24292E;">::string str1 </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> info[</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">].As</span><span style="color:#D73A49;">&lt;</span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::String</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">Utf8Value</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">std</span><span style="color:#24292E;">::string str2 </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> info[</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">].As</span><span style="color:#D73A49;">&lt;</span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::String</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">Utf8Value</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">std</span><span style="color:#24292E;">::string result </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> str1 </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> str2;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">String</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">New</span><span style="color:#24292E;">(env, result);</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">Object</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Init</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">Env</span><span style="color:#24292E;"> </span><span style="color:#E36209;">env</span><span style="color:#24292E;">, </span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">Object</span><span style="color:#24292E;"> </span><span style="color:#E36209;">exports</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">  exports.</span><span style="color:#6F42C1;">Set</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">String</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">New</span><span style="color:#24292E;">(env, </span><span style="color:#032F62;">&quot;concatString&quot;</span><span style="color:#24292E;">),</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">Function</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">New</span><span style="color:#24292E;">(env, JsConcatString, </span><span style="color:#032F62;">&quot;concatString&quot;</span><span style="color:#24292E;">));</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> exports;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">NODE_API_MODULE</span><span style="color:#24292E;">(NODE_GYP_MODULE_NAME, Init)</span></span></code></pre></div><h2 id="传递回调函数" tabindex="-1">传递回调函数 <a class="header-anchor" href="#传递回调函数" aria-label="Permalink to &quot;传递回调函数&quot;">​</a></h2><p>让我们改一下上面的例子，传递一个 JavaScript 回调函数来接收字符串连接的结果。</p><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">export</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">declare</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">concatString</span><span style="color:#E1E4E8;"> (</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#FFAB70;">str1</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">string</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#FFAB70;">str2</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">string</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">callback</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> (</span><span style="color:#FFAB70;">result</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">string</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">void</span></span>
<span class="line"><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">void</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">export</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">declare</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">function</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">concatString</span><span style="color:#24292E;"> (</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#E36209;">str1</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">string</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#E36209;">str2</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">string</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">callback</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> (</span><span style="color:#E36209;">result</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">string</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">void</span></span>
<span class="line"><span style="color:#24292E;">)</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">void</span></span></code></pre></div><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">Module.</span><span style="color:#B392F0;">onRuntimeInitialized</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;"> () {</span></span>
<span class="line"><span style="color:#E1E4E8;">  Module.emnapiExports.</span><span style="color:#B392F0;">concatString</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;Hello &#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;世界&#39;</span><span style="color:#E1E4E8;">, (</span><span style="color:#FFAB70;">result</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(result) </span><span style="color:#6A737D;">// &#39;Hello 世界&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">  })</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">Module.</span><span style="color:#6F42C1;">onRuntimeInitialized</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">function</span><span style="color:#24292E;"> () {</span></span>
<span class="line"><span style="color:#24292E;">  Module.emnapiExports.</span><span style="color:#6F42C1;">concatString</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;Hello &#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;世界&#39;</span><span style="color:#24292E;">, (</span><span style="color:#E36209;">result</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    console.</span><span style="color:#6F42C1;">log</span><span style="color:#24292E;">(result) </span><span style="color:#6A737D;">// &#39;Hello 世界&#39;</span></span>
<span class="line"><span style="color:#24292E;">  })</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h3 id="node-api-实现-1" tabindex="-1">Node-API 实现 <a class="header-anchor" href="#node-api-实现-1" aria-label="Permalink to &quot;Node-API 实现&quot;">​</a></h3><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> napi_value </span><span style="color:#B392F0;">js_concat_string</span><span style="color:#E1E4E8;">(napi_env </span><span style="color:#FFAB70;">env</span><span style="color:#E1E4E8;">, napi_callback_info </span><span style="color:#FFAB70;">info</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">size_t</span><span style="color:#E1E4E8;"> argc </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  napi_value </span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">];</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">NAPI_CALL</span><span style="color:#E1E4E8;">(env, </span><span style="color:#B392F0;">napi_get_cb_info</span><span style="color:#E1E4E8;">(env, info, </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">argc, args, </span><span style="color:#79B8FF;">NULL</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">NULL</span><span style="color:#E1E4E8;">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (argc </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">napi_throw_type_error</span><span style="color:#E1E4E8;">(env, </span><span style="color:#79B8FF;">NULL</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;Wrong number of arguments&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">NULL</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  napi_valuetype valuetype0, valuetype1, valuetype2;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">NAPI_CALL</span><span style="color:#E1E4E8;">(env, </span><span style="color:#B392F0;">napi_typeof</span><span style="color:#E1E4E8;">(env, </span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">], </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">valuetype0));</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">NAPI_CALL</span><span style="color:#E1E4E8;">(env, </span><span style="color:#B392F0;">napi_typeof</span><span style="color:#E1E4E8;">(env, </span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">], </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">valuetype1));</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">NAPI_CALL</span><span style="color:#E1E4E8;">(env, </span><span style="color:#B392F0;">napi_typeof</span><span style="color:#E1E4E8;">(env, </span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">], </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">valuetype2));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (valuetype0 </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> napi_string </span><span style="color:#F97583;">||</span></span>
<span class="line"><span style="color:#E1E4E8;">      valuetype1 </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> napi_string </span><span style="color:#F97583;">||</span></span>
<span class="line"><span style="color:#E1E4E8;">      valuetype2 </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> napi_function) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">napi_throw_type_error</span><span style="color:#E1E4E8;">(env, </span><span style="color:#79B8FF;">NULL</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;Wrong arguments&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">NULL</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">size_t</span><span style="color:#E1E4E8;"> len1 </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">size_t</span><span style="color:#E1E4E8;"> len2 </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">NAPI_CALL</span><span style="color:#E1E4E8;">(env, </span><span style="color:#B392F0;">napi_get_value_string_utf8</span><span style="color:#E1E4E8;">(env, </span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">], </span><span style="color:#79B8FF;">NULL</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">len1));</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">NAPI_CALL</span><span style="color:#E1E4E8;">(env, </span><span style="color:#B392F0;">napi_get_value_string_utf8</span><span style="color:#E1E4E8;">(env, </span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">], </span><span style="color:#79B8FF;">NULL</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">len2));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">size_t</span><span style="color:#E1E4E8;"> total_buffer_size </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> len1 </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> len2 </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">char*</span><span style="color:#E1E4E8;"> str </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">char*</span><span style="color:#E1E4E8;">) </span><span style="color:#B392F0;">malloc</span><span style="color:#E1E4E8;">(total_buffer_size);</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (str </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">NULL</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">napi_throw_error</span><span style="color:#E1E4E8;">(env, </span><span style="color:#79B8FF;">NULL</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;malloc failed&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">NULL</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  napi_status status </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">napi_get_value_string_utf8</span><span style="color:#E1E4E8;">(env, </span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">],</span></span>
<span class="line"><span style="color:#E1E4E8;">                                                  str, total_buffer_size, </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">len1);</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (status </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> napi_ok) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">free</span><span style="color:#E1E4E8;">(str);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">NAPI_CALL</span><span style="color:#E1E4E8;">(env, status);</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  status </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">napi_get_value_string_utf8</span><span style="color:#E1E4E8;">(env, </span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">],</span></span>
<span class="line"><span style="color:#E1E4E8;">                                      str </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> len1, total_buffer_size </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> len1, </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">len2);</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (status </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> napi_ok) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">free</span><span style="color:#E1E4E8;">(str);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">NAPI_CALL</span><span style="color:#E1E4E8;">(env, status);</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">(str </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> len1 </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> len2) </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;</span><span style="color:#79B8FF;">\\0</span><span style="color:#9ECBFF;">&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  napi_value ret;</span></span>
<span class="line"><span style="color:#E1E4E8;">  status </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">napi_create_string_utf8</span><span style="color:#E1E4E8;">(env, str, len1 </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> len2, </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">ret);</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">free</span><span style="color:#E1E4E8;">(str);</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">NAPI_CALL</span><span style="color:#E1E4E8;">(env, status);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  napi_value undefined;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">NAPI_CALL</span><span style="color:#E1E4E8;">(env, </span><span style="color:#B392F0;">napi_get_undefined</span><span style="color:#E1E4E8;">(env, </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">undefined));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  napi_value ignored;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">NAPI_CALL</span><span style="color:#E1E4E8;">(env, </span><span style="color:#B392F0;">napi_call_function</span><span style="color:#E1E4E8;">(env, undefined, </span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">], </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">ret, </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">ignored));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> undefined;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">static</span><span style="color:#24292E;"> napi_value </span><span style="color:#6F42C1;">js_concat_string</span><span style="color:#24292E;">(napi_env </span><span style="color:#E36209;">env</span><span style="color:#24292E;">, napi_callback_info </span><span style="color:#E36209;">info</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">size_t</span><span style="color:#24292E;"> argc </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  napi_value </span><span style="color:#E36209;">args</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">3</span><span style="color:#24292E;">];</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">NAPI_CALL</span><span style="color:#24292E;">(env, </span><span style="color:#6F42C1;">napi_get_cb_info</span><span style="color:#24292E;">(env, info, </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">argc, args, </span><span style="color:#005CC5;">NULL</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">NULL</span><span style="color:#24292E;">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (argc </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">napi_throw_type_error</span><span style="color:#24292E;">(env, </span><span style="color:#005CC5;">NULL</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;Wrong number of arguments&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">NULL</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  napi_valuetype valuetype0, valuetype1, valuetype2;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">NAPI_CALL</span><span style="color:#24292E;">(env, </span><span style="color:#6F42C1;">napi_typeof</span><span style="color:#24292E;">(env, </span><span style="color:#E36209;">args</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">], </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">valuetype0));</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">NAPI_CALL</span><span style="color:#24292E;">(env, </span><span style="color:#6F42C1;">napi_typeof</span><span style="color:#24292E;">(env, </span><span style="color:#E36209;">args</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">], </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">valuetype1));</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">NAPI_CALL</span><span style="color:#24292E;">(env, </span><span style="color:#6F42C1;">napi_typeof</span><span style="color:#24292E;">(env, </span><span style="color:#E36209;">args</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">], </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">valuetype2));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (valuetype0 </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> napi_string </span><span style="color:#D73A49;">||</span></span>
<span class="line"><span style="color:#24292E;">      valuetype1 </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> napi_string </span><span style="color:#D73A49;">||</span></span>
<span class="line"><span style="color:#24292E;">      valuetype2 </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> napi_function) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">napi_throw_type_error</span><span style="color:#24292E;">(env, </span><span style="color:#005CC5;">NULL</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;Wrong arguments&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">NULL</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">size_t</span><span style="color:#24292E;"> len1 </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">size_t</span><span style="color:#24292E;"> len2 </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">NAPI_CALL</span><span style="color:#24292E;">(env, </span><span style="color:#6F42C1;">napi_get_value_string_utf8</span><span style="color:#24292E;">(env, </span><span style="color:#E36209;">args</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">], </span><span style="color:#005CC5;">NULL</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">len1));</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">NAPI_CALL</span><span style="color:#24292E;">(env, </span><span style="color:#6F42C1;">napi_get_value_string_utf8</span><span style="color:#24292E;">(env, </span><span style="color:#E36209;">args</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">], </span><span style="color:#005CC5;">NULL</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">len2));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">size_t</span><span style="color:#24292E;"> total_buffer_size </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> len1 </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> len2 </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">char*</span><span style="color:#24292E;"> str </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">char*</span><span style="color:#24292E;">) </span><span style="color:#6F42C1;">malloc</span><span style="color:#24292E;">(total_buffer_size);</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (str </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">NULL</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">napi_throw_error</span><span style="color:#24292E;">(env, </span><span style="color:#005CC5;">NULL</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;malloc failed&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">NULL</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">  napi_status status </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">napi_get_value_string_utf8</span><span style="color:#24292E;">(env, </span><span style="color:#E36209;">args</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">],</span></span>
<span class="line"><span style="color:#24292E;">                                                  str, total_buffer_size, </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">len1);</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (status </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> napi_ok) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">free</span><span style="color:#24292E;">(str);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">NAPI_CALL</span><span style="color:#24292E;">(env, status);</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">  status </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">napi_get_value_string_utf8</span><span style="color:#24292E;">(env, </span><span style="color:#E36209;">args</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">],</span></span>
<span class="line"><span style="color:#24292E;">                                      str </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> len1, total_buffer_size </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> len1, </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">len2);</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (status </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> napi_ok) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">free</span><span style="color:#24292E;">(str);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">NAPI_CALL</span><span style="color:#24292E;">(env, status);</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">*</span><span style="color:#24292E;">(str </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> len1 </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> len2) </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;</span><span style="color:#005CC5;">\\0</span><span style="color:#032F62;">&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  napi_value ret;</span></span>
<span class="line"><span style="color:#24292E;">  status </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">napi_create_string_utf8</span><span style="color:#24292E;">(env, str, len1 </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> len2, </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">ret);</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">free</span><span style="color:#24292E;">(str);</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">NAPI_CALL</span><span style="color:#24292E;">(env, status);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  napi_value undefined;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">NAPI_CALL</span><span style="color:#24292E;">(env, </span><span style="color:#6F42C1;">napi_get_undefined</span><span style="color:#24292E;">(env, </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">undefined));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  napi_value ignored;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">NAPI_CALL</span><span style="color:#24292E;">(env, </span><span style="color:#6F42C1;">napi_call_function</span><span style="color:#24292E;">(env, undefined, </span><span style="color:#E36209;">args</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">], </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">ret, </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">ignored));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> undefined;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h3 id="node-addon-api-实现-1" tabindex="-1">node-addon-api 实现 <a class="header-anchor" href="#node-addon-api-实现-1" aria-label="Permalink to &quot;node-addon-api 实现&quot;">​</a></h3><div class="warning custom-block"><p class="custom-block-title">WARNING</p><p>如果运行时不支持 <code>FinalizationRegistry</code> 和 <code>WeakRef</code>则<strong>不能</strong>使用 node-addon-api。</p></div><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">Value</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">JsConcatString</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">CallbackInfo</span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;"> </span><span style="color:#FFAB70;">info</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::Env env </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> info.</span><span style="color:#B392F0;">Env</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (info.</span><span style="color:#B392F0;">Length</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::TypeError e </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">TypeError</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">New</span><span style="color:#E1E4E8;">(env, </span><span style="color:#9ECBFF;">&quot;Wrong number of arguments&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">NAPI_THROW</span><span style="color:#E1E4E8;">(e, </span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">Value</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">info[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">].</span><span style="color:#B392F0;">IsString</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">info[</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">].</span><span style="color:#B392F0;">IsString</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">info[</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">].</span><span style="color:#B392F0;">IsFunction</span><span style="color:#E1E4E8;">()) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::TypeError e </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">TypeError</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">New</span><span style="color:#E1E4E8;">(env, </span><span style="color:#9ECBFF;">&quot;Wrong arguments&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">NAPI_THROW</span><span style="color:#E1E4E8;">(e, </span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">Value</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::Value undefined </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> env.</span><span style="color:#B392F0;">Undefined</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">std</span><span style="color:#E1E4E8;">::string str1 </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> info[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">].As</span><span style="color:#F97583;">&lt;</span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::String</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">().</span><span style="color:#B392F0;">Utf8Value</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">std</span><span style="color:#E1E4E8;">::string str2 </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> info[</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">].As</span><span style="color:#F97583;">&lt;</span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::String</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">().</span><span style="color:#B392F0;">Utf8Value</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">std</span><span style="color:#E1E4E8;">::string result </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> str1 </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> str2;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  info[</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">].As</span><span style="color:#F97583;">&lt;</span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::Function</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">().</span><span style="color:#B392F0;">Call</span><span style="color:#E1E4E8;">(undefined, { </span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">String</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">New</span><span style="color:#E1E4E8;">(env, result) })</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> undefined;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">Value</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">JsConcatString</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">CallbackInfo</span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;"> </span><span style="color:#E36209;">info</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::Env env </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> info.</span><span style="color:#6F42C1;">Env</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (info.</span><span style="color:#6F42C1;">Length</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::TypeError e </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">TypeError</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">New</span><span style="color:#24292E;">(env, </span><span style="color:#032F62;">&quot;Wrong number of arguments&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">NAPI_THROW</span><span style="color:#24292E;">(e, </span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">Value</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">!</span><span style="color:#24292E;">info[</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">].</span><span style="color:#6F42C1;">IsString</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">!</span><span style="color:#24292E;">info[</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">].</span><span style="color:#6F42C1;">IsString</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">!</span><span style="color:#24292E;">info[</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">].</span><span style="color:#6F42C1;">IsFunction</span><span style="color:#24292E;">()) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::TypeError e </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">TypeError</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">New</span><span style="color:#24292E;">(env, </span><span style="color:#032F62;">&quot;Wrong arguments&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">NAPI_THROW</span><span style="color:#24292E;">(e, </span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">Value</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::Value undefined </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> env.</span><span style="color:#6F42C1;">Undefined</span><span style="color:#24292E;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">std</span><span style="color:#24292E;">::string str1 </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> info[</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">].As</span><span style="color:#D73A49;">&lt;</span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::String</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">Utf8Value</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">std</span><span style="color:#24292E;">::string str2 </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> info[</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">].As</span><span style="color:#D73A49;">&lt;</span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::String</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">Utf8Value</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">std</span><span style="color:#24292E;">::string result </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> str1 </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> str2;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  info[</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">].As</span><span style="color:#D73A49;">&lt;</span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::Function</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">Call</span><span style="color:#24292E;">(undefined, { </span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">String</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">New</span><span style="color:#24292E;">(env, result) })</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> undefined;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div>`,19),e=[o];function t(c,r,E,y,i,F){return n(),a("div",null,e)}const _=s(l,[["render",t]]);export{u as __pageData,_ as default};
