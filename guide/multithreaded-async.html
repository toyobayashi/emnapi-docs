<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Multithreaded Asynchronous Operations | emnapi</title>
    <meta name="description" content="emnapi - The Subset of Node-API implementation for WebAssembly">
    <link rel="preload stylesheet" href="/emnapi-docs/assets/style.5fa5a060.css" as="style">
    
    <script type="module" src="/emnapi-docs/assets/app.418ac9ce.js"></script>
    <link rel="preload" href="/emnapi-docs/assets/inter-roman-latin.2ed14f66.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/emnapi-docs/assets/chunks/framework.957b8f8c.js">
    <link rel="modulepreload" href="/emnapi-docs/assets/chunks/theme.2dd96335.js">
    <link rel="modulepreload" href="/emnapi-docs/assets/guide_multithreaded-async.md.d782933a.lean.js">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-5a346dfe><!--[--><!--]--><!--[--><span tabindex="-1" data-v-0f60ec36></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-0f60ec36> Skip to content </a><!--]--><!----><header class="VPNav" data-v-5a346dfe data-v-ae24b3ad><div class="VPNavBar has-sidebar" data-v-ae24b3ad data-v-a0fd61f4><div class="container" data-v-a0fd61f4><div class="title" data-v-a0fd61f4><div class="VPNavBarTitle has-sidebar" data-v-a0fd61f4 data-v-86d1bed8><a class="title" href="/emnapi-docs/" data-v-86d1bed8><!--[--><!--]--><!--[--><img class="VPImage logo" src="/emnapi-docs/emnapi.svg" alt data-v-8426fc1a><!--]--><!--[-->emnapi<!--]--><!--[--><!--]--></a></div></div><div class="content" data-v-a0fd61f4><div class="curtain" data-v-a0fd61f4></div><div class="content-body" data-v-a0fd61f4><!--[--><!--]--><div class="VPNavBarSearch search" data-v-a0fd61f4><!--[--><!----><div id="docsearch"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg class="DocSearch-Search-Icon" width="20" height="20" viewBox="0 0 20 20" aria-label="search icon"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div><!--]--></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-a0fd61f4 data-v-7f418b0f><span id="main-nav-aria-label" class="visually-hidden" data-v-7f418b0f>Main Navigation</span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink active" href="/emnapi-docs/guide/" tabindex="0" data-v-7f418b0f data-v-42ef59de><!--[--><span data-v-42ef59de>Guide</span><!--]--></a><!--]--><!--[--><a class="VPLink link vp-external-link-icon VPNavBarMenuLink" href="https://github.com/toyobayashi/node-addon-examples" target="_blank" rel="noreferrer" tabindex="0" data-v-7f418b0f data-v-42ef59de><!--[--><span data-v-42ef59de>Examples</span><!--]--></a><!--]--><!--[--><a class="VPLink link vp-external-link-icon VPNavBarMenuLink" href="https://github.com/toyobayashi/emnapi-docs" target="_blank" rel="noreferrer" tabindex="0" data-v-7f418b0f data-v-42ef59de><!--[--><span data-v-42ef59de>Docs Repo</span><!--]--></a><!--]--><!--]--></nav><div class="VPFlyout VPNavBarTranslations translations" data-v-a0fd61f4 data-v-74abcbb9 data-v-9c007e85><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="Change language" data-v-9c007e85><span class="text" data-v-9c007e85><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="option-icon" data-v-9c007e85><path d="M0 0h24v24H0z" fill="none"></path><path d=" M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z " class="css-c4d79v"></path></svg><!----><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-9c007e85><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-9c007e85><div class="VPMenu" data-v-9c007e85 data-v-e7ea1737><!----><!--[--><!--[--><div class="items" data-v-74abcbb9><p class="title" data-v-74abcbb9>English</p><!--[--><div class="VPMenuLink" data-v-74abcbb9 data-v-43f1e123><a class="VPLink link" href="/emnapi-docs/zh/guide/multithreaded-async.html" data-v-43f1e123><!--[-->简体中文<!--]--></a></div><!--]--></div><!--]--><!--]--></div></div></div><div class="VPNavBarAppearance appearance" data-v-a0fd61f4 data-v-e6aabb21><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="toggle dark mode" aria-checked="false" data-v-e6aabb21 data-v-ce54a7d1 data-v-b1685198><span class="check" data-v-b1685198><span class="icon" data-v-b1685198><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-ce54a7d1><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-ce54a7d1><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-a0fd61f4 data-v-0394ad82 data-v-7bc22406><!--[--><a class="VPSocialLink no-icon" href="https://github.com/toyobayashi/emnapi" aria-label="github" target="_blank" rel="noopener" data-v-7bc22406 data-v-f80f8133><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-a0fd61f4 data-v-40855f84 data-v-9c007e85><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-9c007e85><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-9c007e85><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button><div class="menu" data-v-9c007e85><div class="VPMenu" data-v-9c007e85 data-v-e7ea1737><!----><!--[--><!--[--><div class="group translations" data-v-40855f84><p class="trans-title" data-v-40855f84>English</p><!--[--><div class="VPMenuLink" data-v-40855f84 data-v-43f1e123><a class="VPLink link" href="/emnapi-docs/zh/guide/multithreaded-async.html" data-v-43f1e123><!--[-->简体中文<!--]--></a></div><!--]--></div><div class="group" data-v-40855f84><div class="item appearance" data-v-40855f84><p class="label" data-v-40855f84>Appearance</p><div class="appearance-action" data-v-40855f84><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="toggle dark mode" aria-checked="false" data-v-40855f84 data-v-ce54a7d1 data-v-b1685198><span class="check" data-v-b1685198><span class="icon" data-v-b1685198><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-ce54a7d1><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-ce54a7d1><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div></div></div><div class="group" data-v-40855f84><div class="item social-links" data-v-40855f84><div class="VPSocialLinks social-links-list" data-v-40855f84 data-v-7bc22406><!--[--><a class="VPSocialLink no-icon" href="https://github.com/toyobayashi/emnapi" aria-label="github" target="_blank" rel="noopener" data-v-7bc22406 data-v-f80f8133><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-a0fd61f4 data-v-e5dd9c1c><span class="container" data-v-e5dd9c1c><span class="top" data-v-e5dd9c1c></span><span class="middle" data-v-e5dd9c1c></span><span class="bottom" data-v-e5dd9c1c></span></span></button></div></div></div></div><!----></header><div class="VPLocalNav reached-top" data-v-5a346dfe data-v-79c8c1df><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-79c8c1df><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="menu-icon" data-v-79c8c1df><path d="M17,11H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,11,17,11z"></path><path d="M21,7H3C2.4,7,2,6.6,2,6s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,7,21,7z"></path><path d="M21,15H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,15,21,15z"></path><path d="M17,19H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,19,17,19z"></path></svg><span class="menu-text" data-v-79c8c1df>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-79c8c1df data-v-1c15a60a><button data-v-1c15a60a>Return to top</button><!----></div></div><aside class="VPSidebar" data-v-5a346dfe data-v-b00e2fdd><div class="curtain" data-v-b00e2fdd></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-b00e2fdd><span class="visually-hidden" id="sidebar-aria-label" data-v-b00e2fdd> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0" data-v-b00e2fdd data-v-e31bd47b><div class="item" role="button" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><h2 class="text" data-v-e31bd47b>Guide</h2><!----></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/emnapi-docs/guide/" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Introduction</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/emnapi-docs/guide/getting-started.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Getting Started</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/emnapi-docs/guide/using-cpp.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Using C++ and node-addon-api</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/emnapi-docs/guide/using-cmake.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Using CMake</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/emnapi-docs/guide/using-rust.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Using Rust (Experimental)</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/emnapi-docs/guide/error-handling.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Error Handling</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/emnapi-docs/guide/function-binding.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Function Binding</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/emnapi-docs/guide/class-binding.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Class Binding</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0 has-active" data-v-b00e2fdd data-v-e31bd47b><div class="item" role="button" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><h2 class="text" data-v-e31bd47b>Advanced</h2><!----></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/emnapi-docs/guide/modularization.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Modularization</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/emnapi-docs/guide/multithreaded-async.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Multithreaded Asynchronous Operations</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/emnapi-docs/guide/tsfn.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Thread Safe Function</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/emnapi-docs/guide/faq.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>FAQ</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0" data-v-b00e2fdd data-v-e31bd47b><div class="item" role="button" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><h2 class="text" data-v-e31bd47b>API</h2><!----></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/emnapi-docs/reference/list.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>API List</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/emnapi-docs/reference/additional.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Additional APIs</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-5a346dfe data-v-669faec9><div class="VPDoc has-sidebar has-aside" data-v-669faec9 data-v-6b87e69f><!--[--><!--]--><div class="container" data-v-6b87e69f><div class="aside" data-v-6b87e69f><div class="aside-curtain" data-v-6b87e69f></div><div class="aside-container" data-v-6b87e69f><div class="aside-content" data-v-6b87e69f><div class="VPDocAside" data-v-6b87e69f data-v-3f215769><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline" role="navigation" data-v-3f215769 data-v-d330b1bb><div class="content" data-v-d330b1bb><div class="outline-marker" data-v-d330b1bb></div><div class="outline-title" role="heading" aria-level="2" data-v-d330b1bb>On this page</div><nav aria-labelledby="doc-outline-aria-label" data-v-d330b1bb><span class="visually-hidden" id="doc-outline-aria-label" data-v-d330b1bb> Table of Contents for current page </span><ul class="root" data-v-d330b1bb data-v-d0ee3533><!--[--><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-3f215769></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-6b87e69f><div class="content-container" data-v-6b87e69f><!--[--><!--]--><!----><main class="main" data-v-6b87e69f><div style="position:relative;" class="vp-doc _emnapi-docs_guide_multithreaded-async" data-v-6b87e69f><div><h1 id="multithreaded-asynchronous-operations" tabindex="-1">Multithreaded Asynchronous Operations <a class="header-anchor" href="#multithreaded-asynchronous-operations" aria-label="Permalink to &quot;Multithreaded Asynchronous Operations&quot;">​</a></h1><ul><li><a href="https://nodejs.org/dist/v16.15.0/docs/api/n-api.html#napi_create_async_work" target="_blank" rel="noreferrer">napi_create_async_work</a></li><li><a href="https://nodejs.org/dist/v16.15.0/docs/api/n-api.html#napi_delete_async_work" target="_blank" rel="noreferrer">napi_delete_async_work</a></li><li><a href="https://nodejs.org/dist/v16.15.0/docs/api/n-api.html#napi_queue_async_work" target="_blank" rel="noreferrer">napi_queue_async_work</a></li><li><a href="https://nodejs.org/dist/v16.15.0/docs/api/n-api.html#napi_cancel_async_work" target="_blank" rel="noreferrer">napi_cancel_async_work</a></li></ul><p>Emnapi has 3 implementations of async work and 2 implementations of TSFN:</p><ul><li>Async work <ul><li>A. Libuv threadpool and pthread based implementation in C</li><li>B. Single thread mock in JavaScript</li><li>C. Web worker based implementation in C (stack allocation) and JavaScript</li></ul></li><li>TSFN <ul><li>D. Libuv and pthread based implementation in C</li><li>E. Web worker based implementation in JavaScript</li></ul></li></ul><table><thead><tr><th></th><th>Library to Link</th><th><code>wasm32-emscripten</code></th><th><code>wasm32</code></th><th><code>wasm32-wasi</code></th><th><code>wasm32-wasi-threads</code></th></tr></thead><tbody><tr><td>A</td><td>libemnapi-mt.a</td><td>✅</td><td>❌</td><td>❌</td><td>✅</td></tr><tr><td>B</td><td>libemnapi-basic(-mt).a</td><td>✅</td><td>✅</td><td>✅</td><td>✅</td></tr><tr><td>C</td><td>libemnapi-basic-mt.a</td><td>❌</td><td>✅</td><td>❌</td><td>✅</td></tr><tr><td>D</td><td>libemnapi-mt.a</td><td>✅</td><td>❌</td><td>❌</td><td>✅</td></tr><tr><td>E</td><td>libemnapi-basic(-mt).a</td><td>✅</td><td>✅</td><td>✅</td><td>✅</td></tr></tbody></table><p>There are some limitations on browser about wasi-libc&#39;s pthread implementation, for example <code>pthread_mutex_lock</code> may call <code>__builtin_wasm_memory_atomic_wait32</code>(<code>memory.atomic.wait32</code>) which is disallowed in browser JS main thread. While Emscripten&#39;s pthread implementation has considered usage in browser. If you need to run your addon with multithreaded features on browser, we recommend you use Emscripten A &amp; D, or bare wasm32 C &amp; E.</p><p>Note: For browsers, all the multithreaded features relying on Web Workers (Emscripten pthread also relying on Web Workers) require cross-origin isolation to enable <code>SharedArrayBuffer</code>. You can make a page cross-origin isolated by serving the page with these headers:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">Cross-Origin-Embedder-Policy: require-corp</span></span>
<span class="line"><span style="color:#e1e4e8;">Cross-Origin-Opener-Policy: same-origin</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">Cross-Origin-Embedder-Policy: require-corp</span></span>
<span class="line"><span style="color:#24292e;">Cross-Origin-Opener-Policy: same-origin</span></span></code></pre></div><p>If you would like to avoid <code>SharedArrayBuffer</code> and cross-origin isolation, please use B &amp; E (link <code>libemnapi-basic.a</code>), see the following table for more details.</p><h2 id="about-prebuilt-libraries" tabindex="-1">About Prebuilt Libraries <a class="header-anchor" href="#about-prebuilt-libraries" aria-label="Permalink to &quot;About Prebuilt Libraries&quot;">​</a></h2><p>Prebuilt libraries can be found in the <code>lib</code> directory in <code>emnapi</code> npm package.</p><table><thead><tr><th>Library</th><th>Description</th><th><code>wasm32-emscripten</code></th><th><code>wasm32</code></th><th><code>wasm32-wasi</code></th><th><code>wasm32-wasi-threads</code></th></tr></thead><tbody><tr><td>libemnapi.a</td><td>no atomics feature.<br><br> no libuv port.<br><br> <code>napi_*_async_work</code> and <code>napi_*_threadsafe_function</code> always return <code>napi_generic_failure</code>.</td><td>✅</td><td>✅</td><td>✅</td><td>✅</td></tr><tr><td>libemnapi-mt.a</td><td>atomics feature enabled.<br><br> <code>napi_*_async_work</code> and <code>napi_*_threadsafe_function</code> are based on pthread and libuv port.</td><td>✅</td><td>❌</td><td>❌</td><td>✅</td></tr><tr><td>libemnapi-basic.a</td><td>no atomics feature.<br><br> no libuv port.<br><br> <code>napi_*_async_work</code> and <code>napi_*_threadsafe_function</code> are imported from JavaScript land.</td><td>✅</td><td>✅</td><td>✅</td><td>✅</td></tr><tr><td>libemnapi-basic-mt.a</td><td>atomics feature enabled.<br><br> no libuv port.<br><br> <code>napi_*_async_work</code> and <code>napi_*_threadsafe_function</code> are imported from JavaScript land.<br><br> include <code>emnapi_async_worker_create</code> and <code>emnapi_async_worker_init</code> for WebWorker based async work implementation.</td><td>❌</td><td>✅</td><td>✅</td><td>✅</td></tr><tr><td>libdlmalloc.a</td><td>no atomics feature, no thread safe garanteed.</td><td>❌</td><td>✅</td><td>❌</td><td>❌</td></tr><tr><td>libdlmalloc-mt.a</td><td>atomics feature enabled, thread safe.</td><td>❌</td><td>✅</td><td>❌</td><td>❌</td></tr><tr><td>libemmalloc.a</td><td>no atomics feature, no thread safe garanteed.</td><td>❌</td><td>✅</td><td>❌</td><td>❌</td></tr><tr><td>libemmalloc-mt.a</td><td>atomics feature enabled, thread safe.</td><td>❌</td><td>✅</td><td>❌</td><td>❌</td></tr></tbody></table><h2 id="cmake" tabindex="-1">CMake <a class="header-anchor" href="#cmake" aria-label="Permalink to &quot;CMake&quot;">​</a></h2><div class="language-cmake vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cmake</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">add_subdirectory</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;${CMAKE_CURRENT_SOURCE_DIR}/node_modules/emnapi&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">add_executable</span><span style="color:#E1E4E8;">(hello hello.c)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">CMAKE_SYSTEM_NAME</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">STREQUAL</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;Emscripten&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">  target_link_libraries</span><span style="color:#E1E4E8;">(hello emnapi-mt)</span></span>
<span class="line"><span style="color:#F97583;">  target_compile_options</span><span style="color:#E1E4E8;">(hello </span><span style="color:#B392F0;">PRIVATE</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;-pthread&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  target_link_options(hello </span><span style="color:#B392F0;">PRIVATE</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&quot;-sALLOW_MEMORY_GROWTH=1&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&quot;-sEXPORTED_FUNCTIONS=[&#39;_napi_register_wasm_v1&#39;,&#39;_node_api_module_get_api_version_v1&#39;,&#39;_malloc&#39;,&#39;_free&#39;]&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&quot;-pthread&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&quot;-sPTHREAD_POOL_SIZE=4&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># try to specify stack size if you experience pthread errors</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&quot;-sSTACK_SIZE=2MB&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&quot;-sDEFAULT_PTHREAD_STACK_SIZE=2MB&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  )</span></span>
<span class="line"><span style="color:#F97583;">elseif</span><span style="color:#E1E4E8;">(CMAKE_C_COMPILER_TARGET </span><span style="color:#F97583;">STREQUAL</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;wasm32-wasi-threads&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;"># Experimental</span></span>
<span class="line"><span style="color:#F97583;">  target_link_libraries</span><span style="color:#E1E4E8;">(hello emnapi-mt)</span></span>
<span class="line"><span style="color:#F97583;">  set_target_properties</span><span style="color:#E1E4E8;">(hello PROPERTIES </span><span style="color:#B392F0;">SUFFIX</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;.wasm&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">  target_compile_options</span><span style="color:#E1E4E8;">(hello </span><span style="color:#B392F0;">PRIVATE</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;-fno-exceptions&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;-pthread&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  target_link_options(hello </span><span style="color:#B392F0;">PRIVATE</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&quot;-pthread&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&quot;-mexec-model=reactor&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&quot;-Wl,--import-memory&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&quot;-Wl,--max-memory=2147483648&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&quot;-Wl,--export-dynamic&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&quot;-Wl,--export=malloc&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&quot;-Wl,--export=free&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&quot;-Wl,--import-undefined&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&quot;-Wl,--export-table&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  )</span></span>
<span class="line"><span style="color:#F97583;">elseif</span><span style="color:#E1E4E8;">((CMAKE_C_COMPILER_TARGET </span><span style="color:#F97583;">STREQUAL</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;wasm32&quot;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">OR</span><span style="color:#E1E4E8;"> (CMAKE_C_COMPILER_TARGET </span><span style="color:#F97583;">STREQUAL</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;wasm32-unknown-unknown&quot;</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#F97583;">  target_link_libraries</span><span style="color:#E1E4E8;">(hello emnapi-basic-mt)</span></span>
<span class="line"><span style="color:#F97583;">  set_target_properties</span><span style="color:#E1E4E8;">(hello PROPERTIES </span><span style="color:#B392F0;">SUFFIX</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;.wasm&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">  target_compile_options</span><span style="color:#E1E4E8;">(hello </span><span style="color:#B392F0;">PRIVATE</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;-fno-exceptions&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;-matomics&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;-mbulk-memory&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  target_link_options(hello </span><span style="color:#B392F0;">PRIVATE</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&quot;-nostdlib&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&quot;-Wl,--no-entry&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&quot;-Wl,--export=napi_register_wasm_v1&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&quot;-Wl,--export-if-defined=node_api_module_get_api_version_v1&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&quot;-Wl,--export=emnapi_async_worker_create&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&quot;-Wl,--export=emnapi_async_worker_init&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&quot;-Wl,--import-memory,--shared-memory,--max-memory=2147483648,--import-undefined&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&quot;-Wl,--export-dynamic,--export=malloc,--export=free,--export-table&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  )</span></span>
<span class="line"><span style="color:#F97583;">endif</span><span style="color:#E1E4E8;">()</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">add_subdirectory</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;${CMAKE_CURRENT_SOURCE_DIR}/node_modules/emnapi&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">add_executable</span><span style="color:#24292E;">(hello hello.c)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">CMAKE_SYSTEM_NAME</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">STREQUAL</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Emscripten&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">  target_link_libraries</span><span style="color:#24292E;">(hello emnapi-mt)</span></span>
<span class="line"><span style="color:#D73A49;">  target_compile_options</span><span style="color:#24292E;">(hello </span><span style="color:#6F42C1;">PRIVATE</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;-pthread&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">  target_link_options(hello </span><span style="color:#6F42C1;">PRIVATE</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;-sALLOW_MEMORY_GROWTH=1&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;-sEXPORTED_FUNCTIONS=[&#39;_napi_register_wasm_v1&#39;,&#39;_node_api_module_get_api_version_v1&#39;,&#39;_malloc&#39;,&#39;_free&#39;]&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;-pthread&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;-sPTHREAD_POOL_SIZE=4&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># try to specify stack size if you experience pthread errors</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;-sSTACK_SIZE=2MB&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;-sDEFAULT_PTHREAD_STACK_SIZE=2MB&quot;</span></span>
<span class="line"><span style="color:#24292E;">  )</span></span>
<span class="line"><span style="color:#D73A49;">elseif</span><span style="color:#24292E;">(CMAKE_C_COMPILER_TARGET </span><span style="color:#D73A49;">STREQUAL</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;wasm32-wasi-threads&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;"># Experimental</span></span>
<span class="line"><span style="color:#D73A49;">  target_link_libraries</span><span style="color:#24292E;">(hello emnapi-mt)</span></span>
<span class="line"><span style="color:#D73A49;">  set_target_properties</span><span style="color:#24292E;">(hello PROPERTIES </span><span style="color:#6F42C1;">SUFFIX</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;.wasm&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">  target_compile_options</span><span style="color:#24292E;">(hello </span><span style="color:#6F42C1;">PRIVATE</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;-fno-exceptions&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;-pthread&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">  target_link_options(hello </span><span style="color:#6F42C1;">PRIVATE</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;-pthread&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;-mexec-model=reactor&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;-Wl,--import-memory&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;-Wl,--max-memory=2147483648&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;-Wl,--export-dynamic&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;-Wl,--export=malloc&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;-Wl,--export=free&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;-Wl,--import-undefined&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;-Wl,--export-table&quot;</span></span>
<span class="line"><span style="color:#24292E;">  )</span></span>
<span class="line"><span style="color:#D73A49;">elseif</span><span style="color:#24292E;">((CMAKE_C_COMPILER_TARGET </span><span style="color:#D73A49;">STREQUAL</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;wasm32&quot;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">OR</span><span style="color:#24292E;"> (CMAKE_C_COMPILER_TARGET </span><span style="color:#D73A49;">STREQUAL</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;wasm32-unknown-unknown&quot;</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#D73A49;">  target_link_libraries</span><span style="color:#24292E;">(hello emnapi-basic-mt)</span></span>
<span class="line"><span style="color:#D73A49;">  set_target_properties</span><span style="color:#24292E;">(hello PROPERTIES </span><span style="color:#6F42C1;">SUFFIX</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;.wasm&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">  target_compile_options</span><span style="color:#24292E;">(hello </span><span style="color:#6F42C1;">PRIVATE</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;-fno-exceptions&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;-matomics&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;-mbulk-memory&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">  target_link_options(hello </span><span style="color:#6F42C1;">PRIVATE</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;-nostdlib&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;-Wl,--no-entry&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;-Wl,--export=napi_register_wasm_v1&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;-Wl,--export-if-defined=node_api_module_get_api_version_v1&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;-Wl,--export=emnapi_async_worker_create&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;-Wl,--export=emnapi_async_worker_init&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;-Wl,--import-memory,--shared-memory,--max-memory=2147483648,--import-undefined&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;-Wl,--export-dynamic,--export=malloc,--export=free,--export-table&quot;</span></span>
<span class="line"><span style="color:#24292E;">  )</span></span>
<span class="line"><span style="color:#D73A49;">endif</span><span style="color:#24292E;">()</span></span></code></pre></div><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">emcmake</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cmake</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-DCMAKE_BUILD_TYPE=Release</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#79B8FF;">-DEMNAPI_FIND_NODE_ADDON_API=ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#79B8FF;">-DEMNAPI_WORKER_POOL_SIZE=4</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#79B8FF;">-G</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Ninja</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-H.</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-Bbuild</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># wasi-sdk with thread support (Experimental)</span></span>
<span class="line"><span style="color:#B392F0;">cmake</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-DCMAKE_TOOLCHAIN_FILE=</span><span style="color:#E1E4E8;">$WASI_SDK_PATH</span><span style="color:#79B8FF;">/share/cmake/wasi-sdk-pthread.cmake</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">-DWASI_SDK_PREFIX=</span><span style="color:#E1E4E8;">$WASI_SDK_PATH</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">-DEMNAPI_WORKER_POOL_SIZE=4</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">-DEMNAPI_FIND_NODE_ADDON_API=ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">-DCMAKE_BUILD_TYPE=Release</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">-G</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Ninja</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-H.</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-Bbuild</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">cmake</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-DCMAKE_TOOLCHAIN_FILE=node_modules/emnapi/cmake/wasm32.cmake</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">-DLLVM_PREFIX=</span><span style="color:#E1E4E8;">$WASI_SDK_PATH</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">-DCMAKE_BUILD_TYPE=Release</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">-G</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Ninja</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-H.</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-Bbuild</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">cmake</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--build</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">build</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">emcmake</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cmake</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-DCMAKE_BUILD_TYPE=Release</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#005CC5;">-DEMNAPI_FIND_NODE_ADDON_API=ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#005CC5;">-DEMNAPI_WORKER_POOL_SIZE=4</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#005CC5;">-G</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Ninja</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-H.</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-Bbuild</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># wasi-sdk with thread support (Experimental)</span></span>
<span class="line"><span style="color:#6F42C1;">cmake</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-DCMAKE_TOOLCHAIN_FILE=</span><span style="color:#24292E;">$WASI_SDK_PATH</span><span style="color:#005CC5;">/share/cmake/wasi-sdk-pthread.cmake</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#005CC5;">-DWASI_SDK_PREFIX=</span><span style="color:#24292E;">$WASI_SDK_PATH</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#005CC5;">-DEMNAPI_WORKER_POOL_SIZE=4</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#005CC5;">-DEMNAPI_FIND_NODE_ADDON_API=ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#005CC5;">-DCMAKE_BUILD_TYPE=Release</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#005CC5;">-G</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Ninja</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-H.</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-Bbuild</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">cmake</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-DCMAKE_TOOLCHAIN_FILE=node_modules/emnapi/cmake/wasm32.cmake</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#005CC5;">-DLLVM_PREFIX=</span><span style="color:#24292E;">$WASI_SDK_PATH</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#005CC5;">-DCMAKE_BUILD_TYPE=Release</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#005CC5;">-G</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Ninja</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-H.</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-Bbuild</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">cmake</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--build</span><span style="color:#24292E;"> </span><span style="color:#032F62;">build</span></span></code></pre></div><h2 id="initialization" tabindex="-1">Initialization <a class="header-anchor" href="#initialization" aria-label="Permalink to &quot;Initialization&quot;">​</a></h2><p>Additional work is required during instantiating wasm compiled with non-emscripten.</p><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// emnapi main thread (could be in a Worker)</span></span>
<span class="line"><span style="color:#B392F0;">instantiateNapiModule</span><span style="color:#E1E4E8;">(input, {</span></span>
<span class="line"><span style="color:#E1E4E8;">  context: </span><span style="color:#B392F0;">getDefaultContext</span><span style="color:#E1E4E8;">(),</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;">   * emscripten</span></span>
<span class="line"><span style="color:#6A737D;">   *   0: no effect</span></span>
<span class="line"><span style="color:#6A737D;">   *   &gt; 0: the same effect to UV_THREADPOOL_SIZE</span></span>
<span class="line"><span style="color:#6A737D;">   * non-emscripten</span></span>
<span class="line"><span style="color:#6A737D;">   *   0: single thread mock</span></span>
<span class="line"><span style="color:#6A737D;">   *   &gt; 0 schedule async work in web worker</span></span>
<span class="line"><span style="color:#6A737D;">   */</span></span>
<span class="line"><span style="color:#E1E4E8;">  asyncWorkPoolSize: </span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">, </span><span style="color:#6A737D;">// 0: single thread mock, &gt; 0: schedule async work in web worker</span></span>
<span class="line"><span style="color:#E1E4E8;">  wasi: </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">WASI</span><span style="color:#E1E4E8;">(</span><span style="color:#6A737D;">/* ... */</span><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">// reuseWorker: true,</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">onCreateWorker</span><span style="color:#E1E4E8;"> () {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Worker</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;./worker.js&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// Node.js</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// const { Worker } = require(&#39;worker_threads&#39;)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// return new Worker(join(__dirname, &#39;./worker.js&#39;), {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">//   env: p<wbr>rocess.env,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">//   execArgv: [&#39;--experimental-wasi-unstable-preview1&#39;]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// })</span></span>
<span class="line"><span style="color:#E1E4E8;">  },</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">overwriteImports</span><span style="color:#E1E4E8;"> (</span><span style="color:#FFAB70;">importObject</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    importObject.env.memory </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> WebAssembly.</span><span style="color:#B392F0;">Memory</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">      initial: </span><span style="color:#79B8FF;">16777216</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">65536</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      maximum: </span><span style="color:#79B8FF;">2147483648</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">65536</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      shared: </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">    })</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">})</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// emnapi main thread (could be in a Worker)</span></span>
<span class="line"><span style="color:#6F42C1;">instantiateNapiModule</span><span style="color:#24292E;">(input, {</span></span>
<span class="line"><span style="color:#24292E;">  context: </span><span style="color:#6F42C1;">getDefaultContext</span><span style="color:#24292E;">(),</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;">   * emscripten</span></span>
<span class="line"><span style="color:#6A737D;">   *   0: no effect</span></span>
<span class="line"><span style="color:#6A737D;">   *   &gt; 0: the same effect to UV_THREADPOOL_SIZE</span></span>
<span class="line"><span style="color:#6A737D;">   * non-emscripten</span></span>
<span class="line"><span style="color:#6A737D;">   *   0: single thread mock</span></span>
<span class="line"><span style="color:#6A737D;">   *   &gt; 0 schedule async work in web worker</span></span>
<span class="line"><span style="color:#6A737D;">   */</span></span>
<span class="line"><span style="color:#24292E;">  asyncWorkPoolSize: </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">, </span><span style="color:#6A737D;">// 0: single thread mock, &gt; 0: schedule async work in web worker</span></span>
<span class="line"><span style="color:#24292E;">  wasi: </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">WASI</span><span style="color:#24292E;">(</span><span style="color:#6A737D;">/* ... */</span><span style="color:#24292E;">),</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">// reuseWorker: true,</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">onCreateWorker</span><span style="color:#24292E;"> () {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Worker</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;./worker.js&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// Node.js</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// const { Worker } = require(&#39;worker_threads&#39;)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// return new Worker(join(__dirname, &#39;./worker.js&#39;), {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">//   env: p<wbr>rocess.env,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">//   execArgv: [&#39;--experimental-wasi-unstable-preview1&#39;]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// })</span></span>
<span class="line"><span style="color:#24292E;">  },</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">overwriteImports</span><span style="color:#24292E;"> (</span><span style="color:#E36209;">importObject</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">    importObject.env.memory </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> WebAssembly.</span><span style="color:#6F42C1;">Memory</span><span style="color:#24292E;">({</span></span>
<span class="line"><span style="color:#24292E;">      initial: </span><span style="color:#005CC5;">16777216</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">65536</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">      maximum: </span><span style="color:#005CC5;">2147483648</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">65536</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">      shared: </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">    })</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">})</span></span></code></pre></div><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// worker.js</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;"> () {</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">let</span><span style="color:#E1E4E8;"> fs, </span><span style="color:#79B8FF;">WASI</span><span style="color:#E1E4E8;">, emnapiCore</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ENVIRONMENT_IS_NODE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">typeof</span><span style="color:#E1E4E8;"> process </span><span style="color:#F97583;">===</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;object&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> process </span><span style="color:#F97583;">!==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;&amp;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">typeof</span><span style="color:#E1E4E8;"> process.versions </span><span style="color:#F97583;">===</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;object&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> process.versions </span><span style="color:#F97583;">!==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;&amp;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">typeof</span><span style="color:#E1E4E8;"> process.versions.node </span><span style="color:#F97583;">===</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;string&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">ENVIRONMENT_IS_NODE</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">nodeWorkerThreads</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">require</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;worker_threads&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">parentPort</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> nodeWorkerThreads.parentPort</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    parentPort.</span><span style="color:#B392F0;">on</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;message&#39;</span><span style="color:#E1E4E8;">, (</span><span style="color:#FFAB70;">data</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">      globalThis.</span><span style="color:#B392F0;">onmessage</span><span style="color:#E1E4E8;">({ data })</span></span>
<span class="line"><span style="color:#E1E4E8;">    })</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    fs </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">require</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;fs&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    Object.</span><span style="color:#B392F0;">assign</span><span style="color:#E1E4E8;">(globalThis, {</span></span>
<span class="line"><span style="color:#E1E4E8;">      self: globalThis,</span></span>
<span class="line"><span style="color:#E1E4E8;">      require,</span></span>
<span class="line"><span style="color:#E1E4E8;">      Worker: nodeWorkerThreads.Worker,</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#B392F0;">importScripts</span><span style="color:#E1E4E8;">: </span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;"> (</span><span style="color:#FFAB70;">f</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        (</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, eval)(fs.</span><span style="color:#B392F0;">readFileSync</span><span style="color:#E1E4E8;">(f, </span><span style="color:#9ECBFF;">&#39;utf8&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;//# sourceURL=&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> f)</span></span>
<span class="line"><span style="color:#E1E4E8;">      },</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#B392F0;">postMessage</span><span style="color:#E1E4E8;">: </span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;"> (</span><span style="color:#FFAB70;">msg</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        parentPort.</span><span style="color:#B392F0;">postMessage</span><span style="color:#E1E4E8;">(msg)</span></span>
<span class="line"><span style="color:#E1E4E8;">      }</span></span>
<span class="line"><span style="color:#E1E4E8;">    })</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">WASI</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">require</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;wasi&#39;</span><span style="color:#E1E4E8;">).</span><span style="color:#79B8FF;">WASI</span></span>
<span class="line"><span style="color:#E1E4E8;">    emnapiCore </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">require</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;@emnapi/core&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">importScripts</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;./node_modules/memfs-browser/dist/memfs.js&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">importScripts</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;./node_modules/@tybys/wasm-util/dist/wasm-util.min.js&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">importScripts</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;./node_modules/@emnapi/core/dist/emnapi-core.js&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    emnapiCore </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> globalThis.emnapiCore</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> { </span><span style="color:#79B8FF;">Volume</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">createFsFromVolume</span><span style="color:#E1E4E8;"> } </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> memfs</span></span>
<span class="line"><span style="color:#E1E4E8;">    fs </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">createFsFromVolume</span><span style="color:#E1E4E8;">(Volume.</span><span style="color:#B392F0;">fromJSON</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#9ECBFF;">&#39;/&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">null</span></span>
<span class="line"><span style="color:#E1E4E8;">    }))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">WASI</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> globalThis.wasmUtil.</span><span style="color:#79B8FF;">WASI</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> { </span><span style="color:#79B8FF;">instantiateNapiModuleSync</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">MessageHandler</span><span style="color:#E1E4E8;"> } </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> emnapiCore</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">handler</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">MessageHandler</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">onLoad</span><span style="color:#E1E4E8;"> ({ </span><span style="color:#FFAB70;">wasmModule</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">wasmMemory</span><span style="color:#E1E4E8;"> }) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">wasi</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">WASI</span><span style="color:#E1E4E8;">({ fs })</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">instantiateNapiModuleSync</span><span style="color:#E1E4E8;">(wasmModule, {</span></span>
<span class="line"><span style="color:#E1E4E8;">        childThread: </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        wasi,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">overwriteImports</span><span style="color:#E1E4E8;"> (</span><span style="color:#FFAB70;">importObject</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">          importObject.env.memory </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> wasmMemory</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">      })</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  })</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  globalThis.</span><span style="color:#B392F0;">onmessage</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;"> (</span><span style="color:#FFAB70;">e</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    handler.</span><span style="color:#B392F0;">handle</span><span style="color:#E1E4E8;">(e)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// handle other messages</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">})()</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// worker.js</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#D73A49;">function</span><span style="color:#24292E;"> () {</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">let</span><span style="color:#24292E;"> fs, </span><span style="color:#005CC5;">WASI</span><span style="color:#24292E;">, emnapiCore</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ENVIRONMENT_IS_NODE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">typeof</span><span style="color:#24292E;"> process </span><span style="color:#D73A49;">===</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;object&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> process </span><span style="color:#D73A49;">!==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">typeof</span><span style="color:#24292E;"> process.versions </span><span style="color:#D73A49;">===</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;object&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> process.versions </span><span style="color:#D73A49;">!==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">typeof</span><span style="color:#24292E;"> process.versions.node </span><span style="color:#D73A49;">===</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;string&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">ENVIRONMENT_IS_NODE</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">nodeWorkerThreads</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">require</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;worker_threads&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">parentPort</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> nodeWorkerThreads.parentPort</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    parentPort.</span><span style="color:#6F42C1;">on</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;message&#39;</span><span style="color:#24292E;">, (</span><span style="color:#E36209;">data</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">      globalThis.</span><span style="color:#6F42C1;">onmessage</span><span style="color:#24292E;">({ data })</span></span>
<span class="line"><span style="color:#24292E;">    })</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    fs </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">require</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;fs&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    Object.</span><span style="color:#6F42C1;">assign</span><span style="color:#24292E;">(globalThis, {</span></span>
<span class="line"><span style="color:#24292E;">      self: globalThis,</span></span>
<span class="line"><span style="color:#24292E;">      require,</span></span>
<span class="line"><span style="color:#24292E;">      Worker: nodeWorkerThreads.Worker,</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6F42C1;">importScripts</span><span style="color:#24292E;">: </span><span style="color:#D73A49;">function</span><span style="color:#24292E;"> (</span><span style="color:#E36209;">f</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        (</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, eval)(fs.</span><span style="color:#6F42C1;">readFileSync</span><span style="color:#24292E;">(f, </span><span style="color:#032F62;">&#39;utf8&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;//# sourceURL=&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> f)</span></span>
<span class="line"><span style="color:#24292E;">      },</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6F42C1;">postMessage</span><span style="color:#24292E;">: </span><span style="color:#D73A49;">function</span><span style="color:#24292E;"> (</span><span style="color:#E36209;">msg</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        parentPort.</span><span style="color:#6F42C1;">postMessage</span><span style="color:#24292E;">(msg)</span></span>
<span class="line"><span style="color:#24292E;">      }</span></span>
<span class="line"><span style="color:#24292E;">    })</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">WASI</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">require</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;wasi&#39;</span><span style="color:#24292E;">).</span><span style="color:#005CC5;">WASI</span></span>
<span class="line"><span style="color:#24292E;">    emnapiCore </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">require</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;@emnapi/core&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">  } </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">importScripts</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;./node_modules/memfs-browser/dist/memfs.js&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">importScripts</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;./node_modules/@tybys/wasm-util/dist/wasm-util.min.js&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">importScripts</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;./node_modules/@emnapi/core/dist/emnapi-core.js&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    emnapiCore </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> globalThis.emnapiCore</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">const</span><span style="color:#24292E;"> { </span><span style="color:#005CC5;">Volume</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">createFsFromVolume</span><span style="color:#24292E;"> } </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> memfs</span></span>
<span class="line"><span style="color:#24292E;">    fs </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">createFsFromVolume</span><span style="color:#24292E;">(Volume.</span><span style="color:#6F42C1;">fromJSON</span><span style="color:#24292E;">({</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#032F62;">&#39;/&#39;</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">null</span></span>
<span class="line"><span style="color:#24292E;">    }))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">WASI</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> globalThis.wasmUtil.</span><span style="color:#005CC5;">WASI</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">const</span><span style="color:#24292E;"> { </span><span style="color:#005CC5;">instantiateNapiModuleSync</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">MessageHandler</span><span style="color:#24292E;"> } </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> emnapiCore</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">handler</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">MessageHandler</span><span style="color:#24292E;">({</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">onLoad</span><span style="color:#24292E;"> ({ </span><span style="color:#E36209;">wasmModule</span><span style="color:#24292E;">, </span><span style="color:#E36209;">wasmMemory</span><span style="color:#24292E;"> }) {</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">wasi</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">WASI</span><span style="color:#24292E;">({ fs })</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">instantiateNapiModuleSync</span><span style="color:#24292E;">(wasmModule, {</span></span>
<span class="line"><span style="color:#24292E;">        childThread: </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        wasi,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">overwriteImports</span><span style="color:#24292E;"> (</span><span style="color:#E36209;">importObject</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">          importObject.env.memory </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> wasmMemory</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">      })</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">  })</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  globalThis.</span><span style="color:#6F42C1;">onmessage</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">function</span><span style="color:#24292E;"> (</span><span style="color:#E36209;">e</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">    handler.</span><span style="color:#6F42C1;">handle</span><span style="color:#24292E;">(e)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// handle other messages</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">})()</span></span></code></pre></div><h2 id="preprocess-macro-options" tabindex="-1">Preprocess Macro Options <a class="header-anchor" href="#preprocess-macro-options" aria-label="Permalink to &quot;Preprocess Macro Options&quot;">​</a></h2><h3 id="demnapi-worker-pool-size-4" tabindex="-1"><code>-DEMNAPI_WORKER_POOL_SIZE=4</code> <a class="header-anchor" href="#demnapi-worker-pool-size-4" aria-label="Permalink to &quot;`-DEMNAPI_WORKER_POOL_SIZE=4`&quot;">​</a></h3><p>This is <a href="http://docs.libuv.org/en/v1.x/threadpool.html?highlight=UV_THREADPOOL_SIZE" target="_blank" rel="noreferrer"><code>UV_THREADPOOL_SIZE</code></a> equivalent at compile time, if not predefined, emnapi will read <code>asyncWorkPoolSize</code> option or <code>UV_THREADPOOL_SIZE</code> from Emscripten <a href="https://emscripten.org/docs/porting/connecting_cpp_and_javascript/Interacting-with-code.html#interacting-with-code-environment-variables" target="_blank" rel="noreferrer">environment variable</a> at runtime:</p><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">Module.</span><span style="color:#B392F0;">init</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">// ...</span></span>
<span class="line"><span style="color:#E1E4E8;">  asyncWorkPoolSize: </span><span style="color:#79B8FF;">2</span></span>
<span class="line"><span style="color:#E1E4E8;">})</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// if asyncWorkPoolSize is not specified</span></span>
<span class="line"><span style="color:#E1E4E8;">Module.preRun </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> Module.preRun </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> [];</span></span>
<span class="line"><span style="color:#E1E4E8;">Module.preRun.</span><span style="color:#B392F0;">push</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;"> () {</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">typeof</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ENV</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">!==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;undefined&#39;</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">ENV</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">UV_THREADPOOL_SIZE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;2&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">});</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">Module.</span><span style="color:#6F42C1;">init</span><span style="color:#24292E;">({</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">// ...</span></span>
<span class="line"><span style="color:#24292E;">  asyncWorkPoolSize: </span><span style="color:#005CC5;">2</span></span>
<span class="line"><span style="color:#24292E;">})</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// if asyncWorkPoolSize is not specified</span></span>
<span class="line"><span style="color:#24292E;">Module.preRun </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> Module.preRun </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> [];</span></span>
<span class="line"><span style="color:#24292E;">Module.preRun.</span><span style="color:#6F42C1;">push</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">function</span><span style="color:#24292E;"> () {</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">typeof</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ENV</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">!==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;undefined&#39;</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">ENV</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">UV_THREADPOOL_SIZE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;2&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">});</span></span></code></pre></div><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// wasi</span></span>
<span class="line"><span style="color:#B392F0;">instantiateNapiModule</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">// ...</span></span>
<span class="line"><span style="color:#E1E4E8;">  asyncWorkPoolSize: </span><span style="color:#79B8FF;">2</span></span>
<span class="line"><span style="color:#E1E4E8;">})</span></span>
<span class="line"><span style="color:#6A737D;">// if asyncWorkPoolSize is not specified</span></span>
<span class="line"><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">WASI</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">  env: {</span></span>
<span class="line"><span style="color:#E1E4E8;">    UV_THREADPOOL_SIZE: </span><span style="color:#9ECBFF;">&#39;2&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">})</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// wasi</span></span>
<span class="line"><span style="color:#6F42C1;">instantiateNapiModule</span><span style="color:#24292E;">({</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">// ...</span></span>
<span class="line"><span style="color:#24292E;">  asyncWorkPoolSize: </span><span style="color:#005CC5;">2</span></span>
<span class="line"><span style="color:#24292E;">})</span></span>
<span class="line"><span style="color:#6A737D;">// if asyncWorkPoolSize is not specified</span></span>
<span class="line"><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">WASI</span><span style="color:#24292E;">({</span></span>
<span class="line"><span style="color:#24292E;">  env: {</span></span>
<span class="line"><span style="color:#24292E;">    UV_THREADPOOL_SIZE: </span><span style="color:#032F62;">&#39;2&#39;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">})</span></span></code></pre></div><p>It represent max of <code>EMNAPI_WORKER_POOL_SIZE</code> async work (<code>napi_queue_async_work</code>) can be executed in parallel. Default is not defined.</p><p>You can set both <code>PTHREAD_POOL_SIZE</code> and <code>EMNAPI_WORKER_POOL_SIZE</code> to <code>number of CPU cores</code> in general. If you use another library function which may create <code>N</code> child threads in async work, then you need to set <code>PTHREAD_POOL_SIZE</code> to <code>EMNAPI_WORKER_POOL_SIZE * (N + 1)</code>.</p><p>This option only has effect if you use <code>-pthread</code>. Emnapi will create <code>EMNAPI_WORKER_POOL_SIZE</code> threads when initializing, it will throw error if <code>PTHREAD_POOL_SIZE &lt; EMNAPI_WORKER_POOL_SIZE &amp;&amp; PTHREAD_POOL_SIZE_STRICT == 2</code>.</p><p>See <a href="https://github.com/toyobayashi/emnapi/issues/8" target="_blank" rel="noreferrer">Issue #8</a> for more detail.</p><h3 id="demnapi-nexttick-type-0" tabindex="-1"><code>-DEMNAPI_NEXTTICK_TYPE=0</code> <a class="header-anchor" href="#demnapi-nexttick-type-0" aria-label="Permalink to &quot;`-DEMNAPI_NEXTTICK_TYPE=0`&quot;">​</a></h3><p>This option only has effect if you use <code>-pthread</code>, Default is <code>0</code>. Tell emnapi how to delay async work in <code>uv_async_send</code> / <code>uv__async_close</code>.</p><ul><li><code>0</code>: Use <code>setImmediate()</code> (Node.js native <code>setImmediate</code> or browser <code>MessageChannel</code> and <code>port.postMessage</code>)</li><li><code>1</code>: Use <code>Promise.resolve().then()</code></li></ul><h3 id="demnapi-use-proxying-1" tabindex="-1"><code>-DEMNAPI_USE_PROXYING=1</code> <a class="header-anchor" href="#demnapi-use-proxying-1" aria-label="Permalink to &quot;`-DEMNAPI_USE_PROXYING=1`&quot;">​</a></h3><p>This option only has effect if you use emscripten <code>-pthread</code>. Default is <code>1</code> if emscripten version <code>&gt;= 3.1.9</code>, else <code>0</code>.</p><ul><li><p><code>0</code></p><p>Use JavaScript implementation to send async work from worker threads, runtime code will access the Emscripten internal <code>PThread</code> object to add custom worker message listener.</p></li><li><p><code>1</code>:</p><p>Use Emscripten <a href="https://emscripten.org/docs/api_reference/proxying.h.html" target="_blank" rel="noreferrer">proxying API</a> to send async work from worker threads in C. If you experience something wrong, you can switch set this to <code>0</code> and feel free to create an issue.</p></li></ul><h2 id="example" tabindex="-1">Example <a class="header-anchor" href="#example" aria-label="Permalink to &quot;Example&quot;">​</a></h2><p>Estimate the value of π by using a Monte Carlo method in child threads. Take <code>points</code> samples of random x and y values on a [0,1][0,1] plane. Calculating the length of the diagonal tells us whether the point lies inside, or outside a quarter circle running from 0,1 to 1,0. The ratio of the number of points inside to outside gives us an approximation of π/4.</p><p>Exposed function signature:</p><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">/** </span></span>
<span class="line"><span style="color:#6A737D;"> * This function creates a child thread if</span></span>
<span class="line"><span style="color:#6A737D;"> * there are idle threads in the thread pool.</span></span>
<span class="line"><span style="color:#6A737D;"> * Callback will be called in main thread after calculating.</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#F97583;">export</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">declare</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">estimate</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#FFAB70;">points</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">number</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#FFAB70;">callback</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    (</span><span style="color:#FFAB70;">err</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Error</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">void</span></span>
<span class="line"><span style="color:#E1E4E8;">    (</span><span style="color:#FFAB70;">err</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">result</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">number</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">void</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">void</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">/** </span></span>
<span class="line"><span style="color:#6A737D;"> * This function creates a child thread if</span></span>
<span class="line"><span style="color:#6A737D;"> * there are idle threads in the thread pool.</span></span>
<span class="line"><span style="color:#6A737D;"> * Callback will be called in main thread after calculating.</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#D73A49;">export</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">declare</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">function</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">estimate</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#E36209;">points</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">number</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#E36209;">callback</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    (</span><span style="color:#E36209;">err</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Error</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">void</span></span>
<span class="line"><span style="color:#24292E;">    (</span><span style="color:#E36209;">err</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">, </span><span style="color:#E36209;">result</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">number</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">void</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">)</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">void</span></span></code></pre></div><p>Use case:</p><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">Module.</span><span style="color:#B392F0;">onRuntimeInitialized</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;"> () {</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">calculations</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">100000000</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">batches</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">let</span><span style="color:#E1E4E8;"> ended </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">let</span><span style="color:#E1E4E8;"> total </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">let</span><span style="color:#E1E4E8;"> start </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> Date.</span><span style="color:#B392F0;">now</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">done</span><span style="color:#E1E4E8;"> (</span><span style="color:#FFAB70;">err</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">result</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    total </span><span style="color:#F97583;">+=</span><span style="color:#E1E4E8;"> result;</span></span>
<span class="line"><span style="color:#E1E4E8;">    console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(result)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">++</span><span style="color:#E1E4E8;">ended </span><span style="color:#F97583;">===</span><span style="color:#E1E4E8;"> batches) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#6A737D;">// have all the batches finished executing</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">pi</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> total </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> batches</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ms</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> Date.</span><span style="color:#B392F0;">now</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> start</span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;</span><span style="color:#79B8FF;">\t</span><span style="color:#9ECBFF;">π ≈ &#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> pi </span><span style="color:#F97583;">+</span></span>
<span class="line"><span style="color:#E1E4E8;">                  </span><span style="color:#9ECBFF;">&#39; (&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> Math.</span><span style="color:#B392F0;">abs</span><span style="color:#E1E4E8;">(pi </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> Math.</span><span style="color:#79B8FF;">PI</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39; away from actual)&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;</span><span style="color:#79B8FF;">\t</span><span style="color:#9ECBFF;">Took &#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> ms </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;ms&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">let</span><span style="color:#E1E4E8;"> i </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">; i </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> batches; </span><span style="color:#F97583;">++</span><span style="color:#E1E4E8;">i) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    Module.emnapiExports.</span><span style="color:#B392F0;">estimate</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">100000000</span><span style="color:#E1E4E8;">, done)</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">Module.</span><span style="color:#6F42C1;">onRuntimeInitialized</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">function</span><span style="color:#24292E;"> () {</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">calculations</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">100000000</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">batches</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">let</span><span style="color:#24292E;"> ended </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">let</span><span style="color:#24292E;"> total </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">let</span><span style="color:#24292E;"> start </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> Date.</span><span style="color:#6F42C1;">now</span><span style="color:#24292E;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">function</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">done</span><span style="color:#24292E;"> (</span><span style="color:#E36209;">err</span><span style="color:#24292E;">, </span><span style="color:#E36209;">result</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">    total </span><span style="color:#D73A49;">+=</span><span style="color:#24292E;"> result;</span></span>
<span class="line"><span style="color:#24292E;">    console.</span><span style="color:#6F42C1;">log</span><span style="color:#24292E;">(result)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">++</span><span style="color:#24292E;">ended </span><span style="color:#D73A49;">===</span><span style="color:#24292E;"> batches) {</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6A737D;">// have all the batches finished executing</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">pi</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> total </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> batches</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ms</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> Date.</span><span style="color:#6F42C1;">now</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> start</span></span>
<span class="line"><span style="color:#24292E;">      console.</span><span style="color:#6F42C1;">log</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;</span><span style="color:#005CC5;">\t</span><span style="color:#032F62;">π ≈ &#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> pi </span><span style="color:#D73A49;">+</span></span>
<span class="line"><span style="color:#24292E;">                  </span><span style="color:#032F62;">&#39; (&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> Math.</span><span style="color:#6F42C1;">abs</span><span style="color:#24292E;">(pi </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> Math.</span><span style="color:#005CC5;">PI</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39; away from actual)&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">      console.</span><span style="color:#6F42C1;">log</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;</span><span style="color:#005CC5;">\t</span><span style="color:#032F62;">Took &#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> ms </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;ms&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">      console.</span><span style="color:#6F42C1;">log</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">let</span><span style="color:#24292E;"> i </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">; i </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> batches; </span><span style="color:#D73A49;">++</span><span style="color:#24292E;">i) {</span></span>
<span class="line"><span style="color:#24292E;">    Module.emnapiExports.</span><span style="color:#6F42C1;">estimate</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">100000000</span><span style="color:#24292E;">, done)</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>C implementation:</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">#include</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&lt;stdlib.h&gt;</span></span>
<span class="line"><span style="color:#F97583;">#include</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&lt;pthread.h&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">#ifdef</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">__cplusplus</span></span>
<span class="line"><span style="color:#F97583;">extern</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;C&quot;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">#endif</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">double</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">monte_carlo_estimate_pi</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#FFAB70;">points</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">#ifdef</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">__cplusplus</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"><span style="color:#F97583;">#endif</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">pthread_mutex_t</span><span style="color:#E1E4E8;"> mutex </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> PTHREAD_MUTEX_INITIALIZER;</span></span>
<span class="line"><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">unsigned</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> randseed </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">double</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">monte_carlo_estimate_pi</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#FFAB70;">points</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> i </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> points;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> inside </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">unsigned</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> seed;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">pthread_mutex_lock</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">mutex);</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (randseed </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    randseed </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">time</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">NULL</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  seed </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">rand_r</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">randseed);</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">pthread_mutex_unlock</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">mutex);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">double</span><span style="color:#E1E4E8;"> rand_max </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">double</span><span style="color:#E1E4E8;">) RAND_MAX;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">while</span><span style="color:#E1E4E8;"> (i</span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">double</span><span style="color:#E1E4E8;"> x </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">rand_r</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">seed) </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> rand_max;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">double</span><span style="color:#E1E4E8;"> y </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">rand_r</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">seed) </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> rand_max;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ((x </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> x) </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> (y </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> y) </span><span style="color:#F97583;">&lt;=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">++</span><span style="color:#E1E4E8;">inside;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> (inside </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">double</span><span style="color:#E1E4E8;">) points) </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">#include</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&lt;stdlib.h&gt;</span></span>
<span class="line"><span style="color:#D73A49;">#include</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&lt;pthread.h&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">#ifdef</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">__cplusplus</span></span>
<span class="line"><span style="color:#D73A49;">extern</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;C&quot;</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#D73A49;">#endif</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">double</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">monte_carlo_estimate_pi</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#E36209;">points</span><span style="color:#24292E;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">#ifdef</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">__cplusplus</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"><span style="color:#D73A49;">#endif</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">pthread_mutex_t</span><span style="color:#24292E;"> mutex </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> PTHREAD_MUTEX_INITIALIZER;</span></span>
<span class="line"><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">unsigned</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> randseed </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">double</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">monte_carlo_estimate_pi</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#E36209;">points</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> i </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> points;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> inside </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">unsigned</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> seed;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">pthread_mutex_lock</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">mutex);</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (randseed </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">    randseed </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">time</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">NULL</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">  seed </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">rand_r</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">randseed);</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">pthread_mutex_unlock</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">mutex);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">double</span><span style="color:#24292E;"> rand_max </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">double</span><span style="color:#24292E;">) RAND_MAX;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">while</span><span style="color:#24292E;"> (i</span><span style="color:#D73A49;">--</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">double</span><span style="color:#24292E;"> x </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">rand_r</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">seed) </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> rand_max;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">double</span><span style="color:#24292E;"> y </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">rand_r</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">seed) </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> rand_max;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ((x </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> x) </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> (y </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> y) </span><span style="color:#D73A49;">&lt;=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">++</span><span style="color:#24292E;">inside;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> (inside </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">double</span><span style="color:#24292E;">) points) </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h2 id="node-api-implementation" tabindex="-1">Node-API Implementation <a class="header-anchor" href="#node-api-implementation" aria-label="Permalink to &quot;Node-API Implementation&quot;">​</a></h2><h3 id="helper-macros-and-initialization" tabindex="-1">Helper Macros and Initialization <a class="header-anchor" href="#helper-macros-and-initialization" aria-label="Permalink to &quot;Helper Macros and Initialization&quot;">​</a></h3><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">#include</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&lt;stdlib.h&gt;</span></span>
<span class="line"><span style="color:#F97583;">#include</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&lt;node_api.h&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">#define</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">NAPI_CALL_BASE</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">env</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">the_call</span><span style="color:#E1E4E8;">, ...)</span><span style="color:#6A737D;"> /* ... */</span></span>
<span class="line"><span style="color:#F97583;">#define</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">NAPI_CALL</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">env</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">the_call</span><span style="color:#E1E4E8;">)</span><span style="color:#6A737D;">           /* ... */</span></span>
<span class="line"><span style="color:#F97583;">#define</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">NAPI_CALL_VOID</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">env</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">the_call</span><span style="color:#E1E4E8;">)</span><span style="color:#6A737D;">      /* ... */</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">NAPI_MODULE_INIT</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">  napi_value estimate_fn;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">NAPI_CALL</span><span style="color:#E1E4E8;">(env, </span><span style="color:#B392F0;">napi_create_function</span><span style="color:#E1E4E8;">(env, </span><span style="color:#9ECBFF;">&quot;estimate&quot;</span><span style="color:#E1E4E8;">, NAPI_AUTO_LENGTH,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                      js_estimate, </span><span style="color:#79B8FF;">NULL</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">estimate_fn));</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">NAPI_CALL</span><span style="color:#E1E4E8;">(env, </span><span style="color:#B392F0;">napi_set_named_property</span><span style="color:#E1E4E8;">(env, exports,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                         </span><span style="color:#9ECBFF;">&quot;estimate&quot;</span><span style="color:#E1E4E8;">, estimate_fn));</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> exports;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">#include</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&lt;stdlib.h&gt;</span></span>
<span class="line"><span style="color:#D73A49;">#include</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&lt;node_api.h&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">#define</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">NAPI_CALL_BASE</span><span style="color:#24292E;">(</span><span style="color:#E36209;">env</span><span style="color:#24292E;">, </span><span style="color:#E36209;">the_call</span><span style="color:#24292E;">, ...)</span><span style="color:#6A737D;"> /* ... */</span></span>
<span class="line"><span style="color:#D73A49;">#define</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">NAPI_CALL</span><span style="color:#24292E;">(</span><span style="color:#E36209;">env</span><span style="color:#24292E;">, </span><span style="color:#E36209;">the_call</span><span style="color:#24292E;">)</span><span style="color:#6A737D;">           /* ... */</span></span>
<span class="line"><span style="color:#D73A49;">#define</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">NAPI_CALL_VOID</span><span style="color:#24292E;">(</span><span style="color:#E36209;">env</span><span style="color:#24292E;">, </span><span style="color:#E36209;">the_call</span><span style="color:#24292E;">)</span><span style="color:#6A737D;">      /* ... */</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">NAPI_MODULE_INIT</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">  napi_value estimate_fn;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">NAPI_CALL</span><span style="color:#24292E;">(env, </span><span style="color:#6F42C1;">napi_create_function</span><span style="color:#24292E;">(env, </span><span style="color:#032F62;">&quot;estimate&quot;</span><span style="color:#24292E;">, NAPI_AUTO_LENGTH,</span></span>
<span class="line"><span style="color:#24292E;">                                      js_estimate, </span><span style="color:#005CC5;">NULL</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">estimate_fn));</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">NAPI_CALL</span><span style="color:#24292E;">(env, </span><span style="color:#6F42C1;">napi_set_named_property</span><span style="color:#24292E;">(env, exports,</span></span>
<span class="line"><span style="color:#24292E;">                                         </span><span style="color:#032F62;">&quot;estimate&quot;</span><span style="color:#24292E;">, estimate_fn));</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> exports;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h3 id="binding-function" tabindex="-1">Binding Function <a class="header-anchor" href="#binding-function" aria-label="Permalink to &quot;Binding Function&quot;">​</a></h3><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">typedef</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">struct</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> points;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">double</span><span style="color:#E1E4E8;"> result;</span></span>
<span class="line"><span style="color:#E1E4E8;">  napi_ref callback;</span></span>
<span class="line"><span style="color:#E1E4E8;">  napi_async_work work;</span></span>
<span class="line"><span style="color:#E1E4E8;">} estimate_request;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> napi_value </span><span style="color:#B392F0;">js_estimate</span><span style="color:#E1E4E8;">(napi_env </span><span style="color:#FFAB70;">env</span><span style="color:#E1E4E8;">, napi_callback_info </span><span style="color:#FFAB70;">info</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">size_t</span><span style="color:#E1E4E8;"> argc </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  napi_value </span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">];</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">NAPI_CALL</span><span style="color:#E1E4E8;">(env, </span><span style="color:#B392F0;">napi_get_cb_info</span><span style="color:#E1E4E8;">(env, info, </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">argc, args, </span><span style="color:#79B8FF;">NULL</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">NULL</span><span style="color:#E1E4E8;">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (argc </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">napi_throw_type_error</span><span style="color:#E1E4E8;">(env, </span><span style="color:#79B8FF;">NULL</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;Wrong number of arguments&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">NULL</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  napi_valuetype valuetype0, valuetype1;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">NAPI_CALL</span><span style="color:#E1E4E8;">(env, </span><span style="color:#B392F0;">napi_typeof</span><span style="color:#E1E4E8;">(env, </span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">], </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">valuetype0));</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">NAPI_CALL</span><span style="color:#E1E4E8;">(env, </span><span style="color:#B392F0;">napi_typeof</span><span style="color:#E1E4E8;">(env, </span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">], </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">valuetype1));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (valuetype0 </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> napi_number </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> valuetype1 </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> napi_function) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">napi_throw_type_error</span><span style="color:#E1E4E8;">(env, </span><span style="color:#79B8FF;">NULL</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;Wrong arguments&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">NULL</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  estimate_request</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> request </span><span style="color:#F97583;">=</span></span>
<span class="line"><span style="color:#E1E4E8;">    (estimate_request</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">) </span><span style="color:#B392F0;">malloc</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">sizeof</span><span style="color:#E1E4E8;">(estimate_request));</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">request) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">napi_throw_type_error</span><span style="color:#E1E4E8;">(env, </span><span style="color:#79B8FF;">NULL</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;malloc failed&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">NULL</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  napi_status status;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  status </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">napi_get_value_int32</span><span style="color:#E1E4E8;">(env, </span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">], </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">request-&gt;points);</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (status </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> napi_ok) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">free</span><span style="color:#E1E4E8;">(request);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">NAPI_CALL</span><span style="color:#E1E4E8;">(env, status);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">NULL</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  status </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">napi_create_reference</span><span style="color:#E1E4E8;">(env, </span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">], </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">request-&gt;callback);</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (status </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> napi_ok) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">free</span><span style="color:#E1E4E8;">(request);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">NAPI_CALL</span><span style="color:#E1E4E8;">(env, status);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">NULL</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  status </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">napi_create_async_work</span><span style="color:#E1E4E8;">(env, </span><span style="color:#79B8FF;">NULL</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">NULL</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                  estimate_on_execute,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                  estimate_on_complete,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                  request,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                  </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">request-&gt;work);</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (status </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> napi_ok) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">free</span><span style="color:#E1E4E8;">(request);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">NAPI_CALL</span><span style="color:#E1E4E8;">(env, status);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">NULL</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  status </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">napi_queue_async_work</span><span style="color:#E1E4E8;">(env, request-&gt;work);</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (status </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> napi_ok) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">free</span><span style="color:#E1E4E8;">(request);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">NAPI_CALL</span><span style="color:#E1E4E8;">(env, status);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">NULL</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">NULL</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">typedef</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">struct</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> points;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">double</span><span style="color:#24292E;"> result;</span></span>
<span class="line"><span style="color:#24292E;">  napi_ref callback;</span></span>
<span class="line"><span style="color:#24292E;">  napi_async_work work;</span></span>
<span class="line"><span style="color:#24292E;">} estimate_request;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">static</span><span style="color:#24292E;"> napi_value </span><span style="color:#6F42C1;">js_estimate</span><span style="color:#24292E;">(napi_env </span><span style="color:#E36209;">env</span><span style="color:#24292E;">, napi_callback_info </span><span style="color:#E36209;">info</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">size_t</span><span style="color:#24292E;"> argc </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  napi_value </span><span style="color:#E36209;">args</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">];</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">NAPI_CALL</span><span style="color:#24292E;">(env, </span><span style="color:#6F42C1;">napi_get_cb_info</span><span style="color:#24292E;">(env, info, </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">argc, args, </span><span style="color:#005CC5;">NULL</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">NULL</span><span style="color:#24292E;">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (argc </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">napi_throw_type_error</span><span style="color:#24292E;">(env, </span><span style="color:#005CC5;">NULL</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;Wrong number of arguments&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">NULL</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  napi_valuetype valuetype0, valuetype1;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">NAPI_CALL</span><span style="color:#24292E;">(env, </span><span style="color:#6F42C1;">napi_typeof</span><span style="color:#24292E;">(env, </span><span style="color:#E36209;">args</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">], </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">valuetype0));</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">NAPI_CALL</span><span style="color:#24292E;">(env, </span><span style="color:#6F42C1;">napi_typeof</span><span style="color:#24292E;">(env, </span><span style="color:#E36209;">args</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">], </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">valuetype1));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (valuetype0 </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> napi_number </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> valuetype1 </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> napi_function) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">napi_throw_type_error</span><span style="color:#24292E;">(env, </span><span style="color:#005CC5;">NULL</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;Wrong arguments&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">NULL</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  estimate_request</span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> request </span><span style="color:#D73A49;">=</span></span>
<span class="line"><span style="color:#24292E;">    (estimate_request</span><span style="color:#D73A49;">*</span><span style="color:#24292E;">) </span><span style="color:#6F42C1;">malloc</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">sizeof</span><span style="color:#24292E;">(estimate_request));</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">!</span><span style="color:#24292E;">request) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">napi_throw_type_error</span><span style="color:#24292E;">(env, </span><span style="color:#005CC5;">NULL</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;malloc failed&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">NULL</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  napi_status status;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  status </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">napi_get_value_int32</span><span style="color:#24292E;">(env, </span><span style="color:#E36209;">args</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">], </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">request-&gt;points);</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (status </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> napi_ok) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">free</span><span style="color:#24292E;">(request);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">NAPI_CALL</span><span style="color:#24292E;">(env, status);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">NULL</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  status </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">napi_create_reference</span><span style="color:#24292E;">(env, </span><span style="color:#E36209;">args</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">], </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">request-&gt;callback);</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (status </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> napi_ok) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">free</span><span style="color:#24292E;">(request);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">NAPI_CALL</span><span style="color:#24292E;">(env, status);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">NULL</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  status </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">napi_create_async_work</span><span style="color:#24292E;">(env, </span><span style="color:#005CC5;">NULL</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">NULL</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                                  estimate_on_execute,</span></span>
<span class="line"><span style="color:#24292E;">                                  estimate_on_complete,</span></span>
<span class="line"><span style="color:#24292E;">                                  request,</span></span>
<span class="line"><span style="color:#24292E;">                                  </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">request-&gt;work);</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (status </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> napi_ok) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">free</span><span style="color:#24292E;">(request);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">NAPI_CALL</span><span style="color:#24292E;">(env, status);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">NULL</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  status </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">napi_queue_async_work</span><span style="color:#24292E;">(env, request-&gt;work);</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (status </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> napi_ok) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">free</span><span style="color:#24292E;">(request);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">NAPI_CALL</span><span style="color:#24292E;">(env, status);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">NULL</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">NULL</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h3 id="execute" tabindex="-1">Execute <a class="header-anchor" href="#execute" aria-label="Permalink to &quot;Execute&quot;">​</a></h3><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// invoked in child thread</span></span>
<span class="line"><span style="color:#6A737D;">// can not interact with JavaScript</span></span>
<span class="line"><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">estimate_on_execute</span><span style="color:#E1E4E8;">(napi_env </span><span style="color:#FFAB70;">env</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">void*</span><span style="color:#E1E4E8;"> </span><span style="color:#FFAB70;">data</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">  estimate_request</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> request </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (estimate_request</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">) data;</span></span>
<span class="line"><span style="color:#E1E4E8;">  request-&gt;result </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">monte_carlo_estimate_pi</span><span style="color:#E1E4E8;">(request-&gt;points);</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// invoked in child thread</span></span>
<span class="line"><span style="color:#6A737D;">// can not interact with JavaScript</span></span>
<span class="line"><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">estimate_on_execute</span><span style="color:#24292E;">(napi_env </span><span style="color:#E36209;">env</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">void*</span><span style="color:#24292E;"> </span><span style="color:#E36209;">data</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">  estimate_request</span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> request </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (estimate_request</span><span style="color:#D73A49;">*</span><span style="color:#24292E;">) data;</span></span>
<span class="line"><span style="color:#24292E;">  request-&gt;result </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">monte_carlo_estimate_pi</span><span style="color:#24292E;">(request-&gt;points);</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h3 id="complete" tabindex="-1">Complete <a class="header-anchor" href="#complete" aria-label="Permalink to &quot;Complete&quot;">​</a></h3><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// invoked in main thread</span></span>
<span class="line"><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">estimate_on_complete</span><span style="color:#E1E4E8;">(napi_env </span><span style="color:#FFAB70;">env</span><span style="color:#E1E4E8;">, napi_status </span><span style="color:#FFAB70;">status</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">void*</span><span style="color:#E1E4E8;"> </span><span style="color:#FFAB70;">data</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">  estimate_request</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> req </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (estimate_request</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">) data;</span></span>
<span class="line"><span style="color:#E1E4E8;">  estimate_request request </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">req;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">free</span><span style="color:#E1E4E8;">(req);</span></span>
<span class="line"><span style="color:#E1E4E8;">  napi_value undefined, callback, callback_ret;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">NAPI_CALL_VOID</span><span style="color:#E1E4E8;">(env, </span><span style="color:#B392F0;">napi_get_undefined</span><span style="color:#E1E4E8;">(env, </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">undefined));</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">NAPI_CALL_VOID</span><span style="color:#E1E4E8;">(env, </span><span style="color:#B392F0;">napi_get_reference_value</span><span style="color:#E1E4E8;">(env,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                               request.callback,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                               </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">callback));</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (status </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> napi_ok) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    napi_value err, errmsg;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">NAPI_CALL_VOID</span><span style="color:#E1E4E8;">(env, </span><span style="color:#B392F0;">napi_create_string_utf8</span><span style="color:#E1E4E8;">(env, </span><span style="color:#9ECBFF;">&quot;Execute failed.&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                                NAPI_AUTO_LENGTH,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                                </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">errmsg));</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">NAPI_CALL_VOID</span><span style="color:#E1E4E8;">(env, </span><span style="color:#B392F0;">napi_create_error</span><span style="color:#E1E4E8;">(env, </span><span style="color:#79B8FF;">NULL</span><span style="color:#E1E4E8;">, errmsg, </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">err));</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">NAPI_CALL_VOID</span><span style="color:#E1E4E8;">(env, </span><span style="color:#B392F0;">napi_call_function</span><span style="color:#E1E4E8;">(env, undefined, callback,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                           </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">err, </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">callback_ret));</span></span>
<span class="line"><span style="color:#E1E4E8;">  } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    napi_value </span><span style="color:#FFAB70;">callback_argv</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">];</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">NAPI_CALL_VOID</span><span style="color:#E1E4E8;">(env, </span><span style="color:#B392F0;">napi_get_null</span><span style="color:#E1E4E8;">(env, callback_argv));</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">NAPI_CALL_VOID</span><span style="color:#E1E4E8;">(env, </span><span style="color:#B392F0;">napi_create_double</span><span style="color:#E1E4E8;">(env,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                          request.result, callback_argv </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">));</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">NAPI_CALL_VOID</span><span style="color:#E1E4E8;">(env, </span><span style="color:#B392F0;">napi_call_function</span><span style="color:#E1E4E8;">(env, undefined, callback,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                          </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">, callback_argv, </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">callback_ret));</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">NAPI_CALL_VOID</span><span style="color:#E1E4E8;">(env, </span><span style="color:#B392F0;">napi_delete_reference</span><span style="color:#E1E4E8;">(env, request.callback));</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">NAPI_CALL_VOID</span><span style="color:#E1E4E8;">(env, </span><span style="color:#B392F0;">napi_delete_async_work</span><span style="color:#E1E4E8;">(env, request.work));</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// invoked in main thread</span></span>
<span class="line"><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">estimate_on_complete</span><span style="color:#24292E;">(napi_env </span><span style="color:#E36209;">env</span><span style="color:#24292E;">, napi_status </span><span style="color:#E36209;">status</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">void*</span><span style="color:#24292E;"> </span><span style="color:#E36209;">data</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">  estimate_request</span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> req </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (estimate_request</span><span style="color:#D73A49;">*</span><span style="color:#24292E;">) data;</span></span>
<span class="line"><span style="color:#24292E;">  estimate_request request </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;">req;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">free</span><span style="color:#24292E;">(req);</span></span>
<span class="line"><span style="color:#24292E;">  napi_value undefined, callback, callback_ret;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">NAPI_CALL_VOID</span><span style="color:#24292E;">(env, </span><span style="color:#6F42C1;">napi_get_undefined</span><span style="color:#24292E;">(env, </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">undefined));</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">NAPI_CALL_VOID</span><span style="color:#24292E;">(env, </span><span style="color:#6F42C1;">napi_get_reference_value</span><span style="color:#24292E;">(env,</span></span>
<span class="line"><span style="color:#24292E;">                                               request.callback,</span></span>
<span class="line"><span style="color:#24292E;">                                               </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">callback));</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (status </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> napi_ok) {</span></span>
<span class="line"><span style="color:#24292E;">    napi_value err, errmsg;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">NAPI_CALL_VOID</span><span style="color:#24292E;">(env, </span><span style="color:#6F42C1;">napi_create_string_utf8</span><span style="color:#24292E;">(env, </span><span style="color:#032F62;">&quot;Execute failed.&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                                                NAPI_AUTO_LENGTH,</span></span>
<span class="line"><span style="color:#24292E;">                                                </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">errmsg));</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">NAPI_CALL_VOID</span><span style="color:#24292E;">(env, </span><span style="color:#6F42C1;">napi_create_error</span><span style="color:#24292E;">(env, </span><span style="color:#005CC5;">NULL</span><span style="color:#24292E;">, errmsg, </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">err));</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">NAPI_CALL_VOID</span><span style="color:#24292E;">(env, </span><span style="color:#6F42C1;">napi_call_function</span><span style="color:#24292E;">(env, undefined, callback,</span></span>
<span class="line"><span style="color:#24292E;">                                           </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">err, </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">callback_ret));</span></span>
<span class="line"><span style="color:#24292E;">  } </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    napi_value </span><span style="color:#E36209;">callback_argv</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">];</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">NAPI_CALL_VOID</span><span style="color:#24292E;">(env, </span><span style="color:#6F42C1;">napi_get_null</span><span style="color:#24292E;">(env, callback_argv));</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">NAPI_CALL_VOID</span><span style="color:#24292E;">(env, </span><span style="color:#6F42C1;">napi_create_double</span><span style="color:#24292E;">(env,</span></span>
<span class="line"><span style="color:#24292E;">                                          request.result, callback_argv </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">));</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">NAPI_CALL_VOID</span><span style="color:#24292E;">(env, </span><span style="color:#6F42C1;">napi_call_function</span><span style="color:#24292E;">(env, undefined, callback,</span></span>
<span class="line"><span style="color:#24292E;">                                          </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">, callback_argv, </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">callback_ret));</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">NAPI_CALL_VOID</span><span style="color:#24292E;">(env, </span><span style="color:#6F42C1;">napi_delete_reference</span><span style="color:#24292E;">(env, request.callback));</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">NAPI_CALL_VOID</span><span style="color:#24292E;">(env, </span><span style="color:#6F42C1;">napi_delete_async_work</span><span style="color:#24292E;">(env, request.work));</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h3 id="return-promise" tabindex="-1">Return Promise <a class="header-anchor" href="#return-promise" aria-label="Permalink to &quot;Return Promise&quot;">​</a></h3><p>Function signature:</p><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">export</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">declare</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">estimate</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">points</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">number</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Promise</span><span style="color:#E1E4E8;">&lt;</span><span style="color:#79B8FF;">number</span><span style="color:#E1E4E8;">&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">export</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">declare</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">function</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">estimate</span><span style="color:#24292E;">(</span><span style="color:#E36209;">points</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">number</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Promise</span><span style="color:#24292E;">&lt;</span><span style="color:#005CC5;">number</span><span style="color:#24292E;">&gt;</span></span></code></pre></div><p>Request structure:</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">typedef</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">struct</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> points;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">double</span><span style="color:#E1E4E8;"> result;</span></span>
<span class="line"><span style="color:#E1E4E8;">  napi_deferred deferred;</span></span>
<span class="line"><span style="color:#E1E4E8;">  napi_async_work work;</span></span>
<span class="line"><span style="color:#E1E4E8;">} estimate_request;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">typedef</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">struct</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> points;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">double</span><span style="color:#24292E;"> result;</span></span>
<span class="line"><span style="color:#24292E;">  napi_deferred deferred;</span></span>
<span class="line"><span style="color:#24292E;">  napi_async_work work;</span></span>
<span class="line"><span style="color:#24292E;">} estimate_request;</span></span></code></pre></div><p>Return promise:</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> napi_value </span><span style="color:#B392F0;">js_estimate</span><span style="color:#E1E4E8;">(napi_env </span><span style="color:#FFAB70;">env</span><span style="color:#E1E4E8;">, napi_callback_info </span><span style="color:#FFAB70;">info</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">// ...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  napi_value promise;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">napi_create_promise</span><span style="color:#E1E4E8;">(env, </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">request-&gt;deferred, </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">promise);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">// ...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> promise;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">static</span><span style="color:#24292E;"> napi_value </span><span style="color:#6F42C1;">js_estimate</span><span style="color:#24292E;">(napi_env </span><span style="color:#E36209;">env</span><span style="color:#24292E;">, napi_callback_info </span><span style="color:#E36209;">info</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">// ...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  napi_value promise;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">napi_create_promise</span><span style="color:#24292E;">(env, </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">request-&gt;deferred, </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">promise);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">// ...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> promise;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>Resolve or reject on complete</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">estimate_on_complete</span><span style="color:#E1E4E8;">(napi_env </span><span style="color:#FFAB70;">env</span><span style="color:#E1E4E8;">, napi_status </span><span style="color:#FFAB70;">status</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">void*</span><span style="color:#E1E4E8;"> </span><span style="color:#FFAB70;">data</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">// ...</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (status </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> napi_ok) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// ...</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">NAPI_CALL_VOID</span><span style="color:#E1E4E8;">(env, </span><span style="color:#B392F0;">napi_reject_deferred</span><span style="color:#E1E4E8;">(env, request.deferred, err));</span></span>
<span class="line"><span style="color:#E1E4E8;">  } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// ...</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">NAPI_CALL_VOID</span><span style="color:#E1E4E8;">(env, </span><span style="color:#B392F0;">napi_resolve_deferred</span><span style="color:#E1E4E8;">(env, request.deferred, </span><span style="color:#FFAB70;">callback_argv</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">]));</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">estimate_on_complete</span><span style="color:#24292E;">(napi_env </span><span style="color:#E36209;">env</span><span style="color:#24292E;">, napi_status </span><span style="color:#E36209;">status</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">void*</span><span style="color:#24292E;"> </span><span style="color:#E36209;">data</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">// ...</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (status </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> napi_ok) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// ...</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">NAPI_CALL_VOID</span><span style="color:#24292E;">(env, </span><span style="color:#6F42C1;">napi_reject_deferred</span><span style="color:#24292E;">(env, request.deferred, err));</span></span>
<span class="line"><span style="color:#24292E;">  } </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// ...</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">NAPI_CALL_VOID</span><span style="color:#24292E;">(env, </span><span style="color:#6F42C1;">napi_resolve_deferred</span><span style="color:#24292E;">(env, request.deferred, </span><span style="color:#E36209;">callback_argv</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">]));</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h2 id="node-addon-api-implementation" tabindex="-1">node-addon-api Implementation <a class="header-anchor" href="#node-addon-api-implementation" aria-label="Permalink to &quot;node-addon-api Implementation&quot;">​</a></h2><div class="warning custom-block"><p class="custom-block-title">WARNING</p><p>You <strong>can not</strong> use node-addon-api if the runtime does not support <code>FinalizationRegistry</code> and <code>WeakRef</code>.</p></div><ul><li><a href="https://github.com/nodejs/node-addon-api/blob/v5.0.0/doc/async_worker.md" target="_blank" rel="noreferrer">node-addon-api AsyncWorker Class</a></li></ul><h3 id="binding-function-1" tabindex="-1">Binding Function <a class="header-anchor" href="#binding-function-1" aria-label="Permalink to &quot;Binding Function&quot;">​</a></h3><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">#include</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&lt;napi.h&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">Value</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">JsEstimate</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">CallbackInfo</span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;"> </span><span style="color:#FFAB70;">info</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::Env env </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> info.</span><span style="color:#B392F0;">Env</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (info.</span><span style="color:#B392F0;">Length</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::TypeError e </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">TypeError</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">New</span><span style="color:#E1E4E8;">(env, </span><span style="color:#9ECBFF;">&quot;Wrong number of arguments&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">NAPI_THROW</span><span style="color:#E1E4E8;">(e, </span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">Value</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">info[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">].</span><span style="color:#B392F0;">IsNumber</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">info[</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">].</span><span style="color:#B392F0;">IsFunction</span><span style="color:#E1E4E8;">()) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::TypeError e </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">TypeError</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">New</span><span style="color:#E1E4E8;">(env, </span><span style="color:#9ECBFF;">&quot;Wrong arguments&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">NAPI_THROW</span><span style="color:#E1E4E8;">(e, </span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">Value</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> points </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> info[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">].As</span><span style="color:#F97583;">&lt;</span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::Number</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">().</span><span style="color:#B392F0;">Uint32Value</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::Function callback </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> info[</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">].As</span><span style="color:#F97583;">&lt;</span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::Function</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">auto*</span><span style="color:#E1E4E8;"> piWorker </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">MonteCarloEstimatePiWorker</span><span style="color:#E1E4E8;">(points, callback);</span></span>
<span class="line"><span style="color:#E1E4E8;">  piWorker-&gt;</span><span style="color:#B392F0;">Queue</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> info.</span><span style="color:#B392F0;">Env</span><span style="color:#E1E4E8;">().</span><span style="color:#B392F0;">Undefined</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">Object</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Init</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">Env</span><span style="color:#E1E4E8;"> </span><span style="color:#FFAB70;">env</span><span style="color:#E1E4E8;">, </span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">Object</span><span style="color:#E1E4E8;"> </span><span style="color:#FFAB70;">exports</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">  exports.</span><span style="color:#B392F0;">Set</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">String</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">New</span><span style="color:#E1E4E8;">(env, </span><span style="color:#9ECBFF;">&quot;estimate&quot;</span><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">Function</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">New</span><span style="color:#E1E4E8;">(env, JsEstimate, </span><span style="color:#9ECBFF;">&quot;estimate&quot;</span><span style="color:#E1E4E8;">));</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> exports;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">NODE_API_MODULE</span><span style="color:#E1E4E8;">(NODE_GYP_MODULE_NAME, Init)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">#include</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&lt;napi.h&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">Value</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">JsEstimate</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">CallbackInfo</span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;"> </span><span style="color:#E36209;">info</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::Env env </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> info.</span><span style="color:#6F42C1;">Env</span><span style="color:#24292E;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (info.</span><span style="color:#6F42C1;">Length</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::TypeError e </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">TypeError</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">New</span><span style="color:#24292E;">(env, </span><span style="color:#032F62;">&quot;Wrong number of arguments&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">NAPI_THROW</span><span style="color:#24292E;">(e, </span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">Value</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">!</span><span style="color:#24292E;">info[</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">].</span><span style="color:#6F42C1;">IsNumber</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">!</span><span style="color:#24292E;">info[</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">].</span><span style="color:#6F42C1;">IsFunction</span><span style="color:#24292E;">()) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::TypeError e </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">TypeError</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">New</span><span style="color:#24292E;">(env, </span><span style="color:#032F62;">&quot;Wrong arguments&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">NAPI_THROW</span><span style="color:#24292E;">(e, </span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">Value</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> points </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> info[</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">].As</span><span style="color:#D73A49;">&lt;</span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::Number</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">Uint32Value</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::Function callback </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> info[</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">].As</span><span style="color:#D73A49;">&lt;</span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::Function</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">auto*</span><span style="color:#24292E;"> piWorker </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">MonteCarloEstimatePiWorker</span><span style="color:#24292E;">(points, callback);</span></span>
<span class="line"><span style="color:#24292E;">  piWorker-&gt;</span><span style="color:#6F42C1;">Queue</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> info.</span><span style="color:#6F42C1;">Env</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">Undefined</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">Object</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Init</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">Env</span><span style="color:#24292E;"> </span><span style="color:#E36209;">env</span><span style="color:#24292E;">, </span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">Object</span><span style="color:#24292E;"> </span><span style="color:#E36209;">exports</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">  exports.</span><span style="color:#6F42C1;">Set</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">String</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">New</span><span style="color:#24292E;">(env, </span><span style="color:#032F62;">&quot;estimate&quot;</span><span style="color:#24292E;">),</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">Function</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">New</span><span style="color:#24292E;">(env, JsEstimate, </span><span style="color:#032F62;">&quot;estimate&quot;</span><span style="color:#24292E;">));</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> exports;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">NODE_API_MODULE</span><span style="color:#24292E;">(NODE_GYP_MODULE_NAME, Init)</span></span></code></pre></div><h3 id="extending-asyncworker-class" tabindex="-1">Extending AsyncWorker Class <a class="header-anchor" href="#extending-asyncworker-class" aria-label="Permalink to &quot;Extending AsyncWorker Class&quot;">​</a></h3><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">MonteCarloEstimatePiWorker</span><span style="color:#E1E4E8;"> : </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">AsyncWorker</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">public:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">MonteCarloEstimatePiWorker</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#FFAB70;">points</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">Function</span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;"> </span><span style="color:#FFAB70;">callback</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">      : Napi::</span><span style="color:#B392F0;">AsyncWorker</span><span style="color:#E1E4E8;">(callback), </span><span style="color:#B392F0;">points_</span><span style="color:#E1E4E8;">(points), </span><span style="color:#B392F0;">result_</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Execute</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#6A737D;">    // in child thread</span></span>
<span class="line"><span style="color:#E1E4E8;">    result_ </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">monte_carlo_estimate_pi</span><span style="color:#E1E4E8;">(points_);</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">OnOK</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#6A737D;">    // in main thread</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">Callback</span><span style="color:#E1E4E8;">().</span><span style="color:#B392F0;">Call</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">Env</span><span style="color:#E1E4E8;">().</span><span style="color:#B392F0;">Undefined</span><span style="color:#E1E4E8;">(), {</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#B392F0;">Env</span><span style="color:#E1E4E8;">().</span><span style="color:#B392F0;">Null</span><span style="color:#E1E4E8;">(),</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">Number</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">New</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">Env</span><span style="color:#E1E4E8;">(), result_)</span></span>
<span class="line"><span style="color:#E1E4E8;">    });</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">OnError</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">Error</span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;"> </span><span style="color:#FFAB70;">e</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#6A737D;">    // in main thread</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">Callback</span><span style="color:#E1E4E8;">().</span><span style="color:#B392F0;">Call</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">Env</span><span style="color:#E1E4E8;">().</span><span style="color:#B392F0;">Undefined</span><span style="color:#E1E4E8;">(), { e.</span><span style="color:#B392F0;">Value</span><span style="color:#E1E4E8;">() });</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">private:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> points_;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">double</span><span style="color:#E1E4E8;"> result_;</span></span>
<span class="line"><span style="color:#E1E4E8;">};</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">MonteCarloEstimatePiWorker</span><span style="color:#24292E;"> : </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">AsyncWorker</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">public:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">MonteCarloEstimatePiWorker</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#E36209;">points</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">Function</span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;"> </span><span style="color:#E36209;">callback</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">      : Napi::</span><span style="color:#6F42C1;">AsyncWorker</span><span style="color:#24292E;">(callback), </span><span style="color:#6F42C1;">points_</span><span style="color:#24292E;">(points), </span><span style="color:#6F42C1;">result_</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Execute</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#6A737D;">    // in child thread</span></span>
<span class="line"><span style="color:#24292E;">    result_ </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">monte_carlo_estimate_pi</span><span style="color:#24292E;">(points_);</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">OnOK</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#6A737D;">    // in main thread</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">Callback</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">Call</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">Env</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">Undefined</span><span style="color:#24292E;">(), {</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6F42C1;">Env</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">Null</span><span style="color:#24292E;">(),</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">Number</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">New</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">Env</span><span style="color:#24292E;">(), result_)</span></span>
<span class="line"><span style="color:#24292E;">    });</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">OnError</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">Error</span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;"> </span><span style="color:#E36209;">e</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#6A737D;">    // in main thread</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">Callback</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">Call</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">Env</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">Undefined</span><span style="color:#24292E;">(), { e.</span><span style="color:#6F42C1;">Value</span><span style="color:#24292E;">() });</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">private:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> points_;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">double</span><span style="color:#24292E;"> result_;</span></span>
<span class="line"><span style="color:#24292E;">};</span></span></code></pre></div><h3 id="return-promise-1" tabindex="-1">Return Promise <a class="header-anchor" href="#return-promise-1" aria-label="Permalink to &quot;Return Promise&quot;">​</a></h3><p>Function signature:</p><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">export</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">declare</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">estimate</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">points</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">number</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Promise</span><span style="color:#E1E4E8;">&lt;</span><span style="color:#79B8FF;">number</span><span style="color:#E1E4E8;">&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">export</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">declare</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">function</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">estimate</span><span style="color:#24292E;">(</span><span style="color:#E36209;">points</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">number</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Promise</span><span style="color:#24292E;">&lt;</span><span style="color:#005CC5;">number</span><span style="color:#24292E;">&gt;</span></span></code></pre></div><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">MonteCarloEstimatePiWorker</span><span style="color:#E1E4E8;"> : </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">AsyncWorker</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">public:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">MonteCarloEstimatePiWorker</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#FFAB70;">points</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">Promise</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">Deferred</span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;"> </span><span style="color:#FFAB70;">deferred</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">      : Napi::</span><span style="color:#B392F0;">AsyncWorker</span><span style="color:#E1E4E8;">(deferred.</span><span style="color:#B392F0;">Env</span><span style="color:#E1E4E8;">()),</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">points_</span><span style="color:#E1E4E8;">(points),</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">result_</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">deferred_</span><span style="color:#E1E4E8;">(deferred) {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Execute</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">    result_ </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">monte_carlo_estimate_pi</span><span style="color:#E1E4E8;">(points_);</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">OnOK</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">    deferred_.</span><span style="color:#B392F0;">Resolve</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">Number</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">New</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">Env</span><span style="color:#E1E4E8;">(), result_));</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">OnError</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">Error</span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;"> </span><span style="color:#FFAB70;">e</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    deferred_.</span><span style="color:#B392F0;">Reject</span><span style="color:#E1E4E8;">(e.</span><span style="color:#B392F0;">Value</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">private:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> points_;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">double</span><span style="color:#E1E4E8;"> result_;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">Promise</span><span style="color:#E1E4E8;">::Deferred deferred_;</span></span>
<span class="line"><span style="color:#E1E4E8;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">Value</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">JsEstimate</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">CallbackInfo</span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;"> </span><span style="color:#FFAB70;">info</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::Env env </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> info.</span><span style="color:#B392F0;">Env</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (info.</span><span style="color:#B392F0;">Length</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::TypeError e </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">TypeError</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">New</span><span style="color:#E1E4E8;">(env, </span><span style="color:#9ECBFF;">&quot;Wrong number of arguments&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">NAPI_THROW</span><span style="color:#E1E4E8;">(e, </span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">Value</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">info[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">].</span><span style="color:#B392F0;">IsNumber</span><span style="color:#E1E4E8;">()) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::TypeError e </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">TypeError</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">New</span><span style="color:#E1E4E8;">(env, </span><span style="color:#9ECBFF;">&quot;Wrong arguments&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">NAPI_THROW</span><span style="color:#E1E4E8;">(e, </span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">Value</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> points </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> info[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">].As</span><span style="color:#F97583;">&lt;</span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::Number</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">().</span><span style="color:#B392F0;">Uint32Value</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">Promise</span><span style="color:#E1E4E8;">::Deferred deferred </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">Promise</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">Deferred</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">New</span><span style="color:#E1E4E8;">(env);</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">auto*</span><span style="color:#E1E4E8;"> piWorker </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">MonteCarloEstimatePiWorker</span><span style="color:#E1E4E8;">(points, deferred);</span></span>
<span class="line"><span style="color:#E1E4E8;">  piWorker-&gt;</span><span style="color:#B392F0;">Queue</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> deferred.</span><span style="color:#B392F0;">Promise</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">MonteCarloEstimatePiWorker</span><span style="color:#24292E;"> : </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">AsyncWorker</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">public:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">MonteCarloEstimatePiWorker</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#E36209;">points</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">Promise</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">Deferred</span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;"> </span><span style="color:#E36209;">deferred</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">      : Napi::</span><span style="color:#6F42C1;">AsyncWorker</span><span style="color:#24292E;">(deferred.</span><span style="color:#6F42C1;">Env</span><span style="color:#24292E;">()),</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">points_</span><span style="color:#24292E;">(points),</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">result_</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">),</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">deferred_</span><span style="color:#24292E;">(deferred) {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Execute</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">    result_ </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">monte_carlo_estimate_pi</span><span style="color:#24292E;">(points_);</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">OnOK</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">    deferred_.</span><span style="color:#6F42C1;">Resolve</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">Number</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">New</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">Env</span><span style="color:#24292E;">(), result_));</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">OnError</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">Error</span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;"> </span><span style="color:#E36209;">e</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">    deferred_.</span><span style="color:#6F42C1;">Reject</span><span style="color:#24292E;">(e.</span><span style="color:#6F42C1;">Value</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">private:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> points_;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">double</span><span style="color:#24292E;"> result_;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">Promise</span><span style="color:#24292E;">::Deferred deferred_;</span></span>
<span class="line"><span style="color:#24292E;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">Value</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">JsEstimate</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">CallbackInfo</span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;"> </span><span style="color:#E36209;">info</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::Env env </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> info.</span><span style="color:#6F42C1;">Env</span><span style="color:#24292E;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (info.</span><span style="color:#6F42C1;">Length</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::TypeError e </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">TypeError</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">New</span><span style="color:#24292E;">(env, </span><span style="color:#032F62;">&quot;Wrong number of arguments&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">NAPI_THROW</span><span style="color:#24292E;">(e, </span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">Value</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">!</span><span style="color:#24292E;">info[</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">].</span><span style="color:#6F42C1;">IsNumber</span><span style="color:#24292E;">()) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::TypeError e </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">TypeError</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">New</span><span style="color:#24292E;">(env, </span><span style="color:#032F62;">&quot;Wrong arguments&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">NAPI_THROW</span><span style="color:#24292E;">(e, </span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">Value</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> points </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> info[</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">].As</span><span style="color:#D73A49;">&lt;</span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::Number</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">Uint32Value</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">Promise</span><span style="color:#24292E;">::Deferred deferred </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Napi</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">Promise</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">Deferred</span><span style="color:#24292E;">::</span><span style="color:#6F42C1;">New</span><span style="color:#24292E;">(env);</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">auto*</span><span style="color:#24292E;"> piWorker </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">MonteCarloEstimatePiWorker</span><span style="color:#24292E;">(points, deferred);</span></span>
<span class="line"><span style="color:#24292E;">  piWorker-&gt;</span><span style="color:#6F42C1;">Queue</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> deferred.</span><span style="color:#6F42C1;">Promise</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div></div></div></main><footer class="VPDocFooter" data-v-6b87e69f data-v-ef5dee53><!--[--><!--]--><div class="edit-info" data-v-ef5dee53><div class="edit-link" data-v-ef5dee53><a class="VPLink link vp-external-link-icon no-icon edit-link-button" href="https://github.com/toyobayashi/emnapi-docs/edit/main/src/guide/multithreaded-async.md" target="_blank" rel="noreferrer" data-v-ef5dee53><!--[--><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="edit-link-icon" aria-label="edit icon" data-v-ef5dee53><path d="M18,23H4c-1.7,0-3-1.3-3-3V6c0-1.7,1.3-3,3-3h7c0.6,0,1,0.4,1,1s-0.4,1-1,1H4C3.4,5,3,5.4,3,6v14c0,0.6,0.4,1,1,1h14c0.6,0,1-0.4,1-1v-7c0-0.6,0.4-1,1-1s1,0.4,1,1v7C21,21.7,19.7,23,18,23z"></path><path d="M8,17c-0.3,0-0.5-0.1-0.7-0.3C7,16.5,6.9,16.1,7,15.8l1-4c0-0.2,0.1-0.3,0.3-0.5l9.5-9.5c1.2-1.2,3.2-1.2,4.4,0c1.2,1.2,1.2,3.2,0,4.4l-9.5,9.5c-0.1,0.1-0.3,0.2-0.5,0.3l-4,1C8.2,17,8.1,17,8,17zM9.9,12.5l-0.5,2.1l2.1-0.5l9.3-9.3c0.4-0.4,0.4-1.1,0-1.6c-0.4-0.4-1.2-0.4-1.6,0l0,0L9.9,12.5z M18.5,2.5L18.5,2.5L18.5,2.5z"></path></svg> Any mistake found? Correct it now!<!--]--></a></div><div class="last-updated" data-v-ef5dee53><p class="VPLastUpdated" data-v-ef5dee53 data-v-7e05ebdb>Last Updated: <time datetime="2023-11-12T03:23:40.000Z" data-v-7e05ebdb></time></p></div></div><nav class="prev-next" data-v-ef5dee53><div class="pager" data-v-ef5dee53><a class="pager-link prev" href="/emnapi-docs/guide/modularization.html" data-v-ef5dee53><span class="desc" data-v-ef5dee53>Previous page</span><span class="title" data-v-ef5dee53>Modularization</span></a></div><div class="pager" data-v-ef5dee53><a class="pager-link next" href="/emnapi-docs/guide/tsfn.html" data-v-ef5dee53><span class="desc" data-v-ef5dee53>Next page</span><span class="title" data-v-ef5dee53>Thread Safe Function</span></a></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><footer class="VPFooter has-sidebar" data-v-5a346dfe data-v-e03eb2e1><div class="container" data-v-e03eb2e1><p class="message" data-v-e03eb2e1>Released under the MIT License.</p><p class="copyright" data-v-e03eb2e1>Copyright © 2021-PRESENT toyobayashi</p></div></footer><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"guide_index.md\":\"78e9a43b\",\"zh_guide_modularization.md\":\"dfba25d1\",\"zh_guide_faq.md\":\"8af9ee84\",\"zh_guide_function-binding.md\":\"555673e0\",\"zh_guide_tsfn.md\":\"2ad3bc96\",\"zh_reference_additional.md\":\"3c840359\",\"zh_reference_list.md\":\"7cbc7b45\",\"zh_guide_class-binding.md\":\"54bb5f7f\",\"zh_guide_using-cpp.md\":\"b868ca41\",\"index.md\":\"f660ada9\",\"guide_using-rust.md\":\"72f01a7b\",\"reference_additional.md\":\"e71eeb2c\",\"zh_index.md\":\"4232c385\",\"reference_list.md\":\"896d6b45\",\"zh_guide_using-rust.md\":\"4889eab9\",\"guide_error-handling.md\":\"25c661f3\",\"guide_function-binding.md\":\"665aaf32\",\"zh_guide_error-handling.md\":\"68f2e9ca\",\"zh_guide_getting-started.md\":\"e268407a\",\"guide_faq.md\":\"0cf94581\",\"zh_guide_index.md\":\"a23dafcb\",\"guide_tsfn.md\":\"ac662168\",\"guide_modularization.md\":\"aa8179d9\",\"guide_using-cpp.md\":\"54747fa7\",\"guide_getting-started.md\":\"4b096fe1\",\"guide_class-binding.md\":\"3c6f98b6\",\"zh_guide_using-cmake.md\":\"ad386e9a\",\"guide_using-cmake.md\":\"9b1d741c\",\"guide_multithreaded-async.md\":\"d782933a\",\"zh_guide_multithreaded-async.md\":\"5ccf82d5\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"emnapi\",\"description\":\"emnapi - The Subset of Node-API implementation for WebAssembly\",\"base\":\"/emnapi-docs/\",\"head\":[],\"appearance\":true,\"themeConfig\":{\"logo\":\"/emnapi.svg\",\"footer\":{\"message\":\"Released under the MIT License.\",\"copyright\":\"Copyright © 2021-PRESENT toyobayashi\"},\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/toyobayashi/emnapi\"}],\"algolia\":{\"appId\":\"0UYMT1XPL1\",\"apiKey\":\"93bb252b942dac8d9c4e6e8432d1ab99\",\"indexName\":\"emnapi\"}},\"locales\":{\"root\":{\"lang\":\"en\",\"label\":\"English\",\"description\":\"emnapi - The Subset of Node-API implementation for WebAssembly\",\"themeConfig\":{\"lastUpdatedText\":\"Last Updated\",\"editLink\":{\"pattern\":\"https://github.com/toyobayashi/emnapi-docs/edit/main/src/:path\",\"text\":\"Any mistake found? Correct it now!\"},\"nav\":[{\"text\":\"Guide\",\"link\":\"//guide/\",\"activeMatch\":\"^/(\\\\S+/)?guide/\"},{\"text\":\"Examples\",\"link\":\"https://github.com/toyobayashi/node-addon-examples\"},{\"text\":\"Docs Repo\",\"link\":\"https://github.com/toyobayashi/emnapi-docs\"}],\"sidebar\":{\"/guide/\":[{\"text\":\"Guide\",\"items\":[{\"text\":\"Introduction\",\"link\":\"/guide/\"},{\"text\":\"Getting Started\",\"link\":\"/guide/getting-started\"},{\"text\":\"Using C++ and node-addon-api\",\"link\":\"/guide/using-cpp\"},{\"text\":\"Using CMake\",\"link\":\"/guide/using-cmake\"},{\"text\":\"Using Rust (Experimental)\",\"link\":\"/guide/using-rust\"},{\"text\":\"Error Handling\",\"link\":\"/guide/error-handling\"},{\"text\":\"Function Binding\",\"link\":\"/guide/function-binding\"},{\"text\":\"Class Binding\",\"link\":\"/guide/class-binding\"}]},{\"text\":\"Advanced\",\"items\":[{\"text\":\"Modularization\",\"link\":\"/guide/modularization\"},{\"text\":\"Multithreaded Asynchronous Operations\",\"link\":\"/guide/multithreaded-async\"},{\"text\":\"Thread Safe Function\",\"link\":\"/guide/tsfn\"},{\"text\":\"FAQ\",\"link\":\"/guide/faq\"}]},{\"text\":\"API\",\"items\":[{\"text\":\"API List\",\"link\":\"/reference/list\"},{\"text\":\"Additional APIs\",\"link\":\"/reference/additional\"}]}],\"/\":[{\"text\":\"Guide\",\"items\":[{\"text\":\"Introduction\",\"link\":\"/guide/\"},{\"text\":\"Getting Started\",\"link\":\"/guide/getting-started\"},{\"text\":\"Using C++ and node-addon-api\",\"link\":\"/guide/using-cpp\"},{\"text\":\"Using CMake\",\"link\":\"/guide/using-cmake\"},{\"text\":\"Using Rust (Experimental)\",\"link\":\"/guide/using-rust\"},{\"text\":\"Error Handling\",\"link\":\"/guide/error-handling\"},{\"text\":\"Function Binding\",\"link\":\"/guide/function-binding\"},{\"text\":\"Class Binding\",\"link\":\"/guide/class-binding\"}]},{\"text\":\"Advanced\",\"items\":[{\"text\":\"Modularization\",\"link\":\"/guide/modularization\"},{\"text\":\"Multithreaded Asynchronous Operations\",\"link\":\"/guide/multithreaded-async\"},{\"text\":\"Thread Safe Function\",\"link\":\"/guide/tsfn\"},{\"text\":\"FAQ\",\"link\":\"/guide/faq\"}]},{\"text\":\"API\",\"items\":[{\"text\":\"API List\",\"link\":\"/reference/list\"},{\"text\":\"Additional APIs\",\"link\":\"/reference/additional\"}]}]}}},\"zh\":{\"lang\":\"zh\",\"label\":\"简体中文\",\"description\":\"emnapi - 适用于 WebAssembly 的 Node-API 子集实现\",\"themeConfig\":{\"lastUpdatedText\":\"上次更新于\",\"editLink\":{\"pattern\":\"https://github.com/toyobayashi/emnapi-docs/edit/main/src/:path\",\"text\":\"在 Github 上编辑本页\"},\"nav\":[{\"text\":\"指南\",\"link\":\"/zh//guide/\",\"activeMatch\":\"^/(\\\\S+/)?guide/\"},{\"text\":\"代码示例\",\"link\":\"https://github.com/toyobayashi/node-addon-examples\"},{\"text\":\"文档仓库\",\"link\":\"https://github.com/toyobayashi/emnapi-docs\"}],\"sidebar\":{\"/zh/guide/\":[{\"text\":\"指南\",\"items\":[{\"text\":\"介绍\",\"link\":\"/zh/guide/\"},{\"text\":\"开始使用\",\"link\":\"/zh/guide/getting-started\"},{\"text\":\"使用 C++ 和 node-addon-api\",\"link\":\"/zh/guide/using-cpp\"},{\"text\":\"使用 CMake\",\"link\":\"/zh/guide/using-cmake\"},{\"text\":\"使用 Rust（实验性）\",\"link\":\"/zh/guide/using-rust\"},{\"text\":\"错误处理\",\"link\":\"/zh/guide/error-handling\"},{\"text\":\"函数绑定\",\"link\":\"/zh/guide/function-binding\"},{\"text\":\"类绑定\",\"link\":\"/zh/guide/class-binding\"}]},{\"text\":\"进阶\",\"items\":[{\"text\":\"模块化\",\"link\":\"/zh/guide/modularization\"},{\"text\":\"多线程异步\",\"link\":\"/zh/guide/multithreaded-async\"},{\"text\":\"线程安全函数\",\"link\":\"/zh/guide/tsfn\"},{\"text\":\"常见问题\",\"link\":\"/zh/guide/faq\"}]},{\"text\":\"API\",\"items\":[{\"text\":\"API 列表\",\"link\":\"/zh/reference/list\"},{\"text\":\"额外新增的 API\",\"link\":\"/zh/reference/additional\"}]}],\"/zh/\":[{\"text\":\"指南\",\"items\":[{\"text\":\"介绍\",\"link\":\"/zh/guide/\"},{\"text\":\"开始使用\",\"link\":\"/zh/guide/getting-started\"},{\"text\":\"使用 C++ 和 node-addon-api\",\"link\":\"/zh/guide/using-cpp\"},{\"text\":\"使用 CMake\",\"link\":\"/zh/guide/using-cmake\"},{\"text\":\"使用 Rust（实验性）\",\"link\":\"/zh/guide/using-rust\"},{\"text\":\"错误处理\",\"link\":\"/zh/guide/error-handling\"},{\"text\":\"函数绑定\",\"link\":\"/zh/guide/function-binding\"},{\"text\":\"类绑定\",\"link\":\"/zh/guide/class-binding\"}]},{\"text\":\"进阶\",\"items\":[{\"text\":\"模块化\",\"link\":\"/zh/guide/modularization\"},{\"text\":\"多线程异步\",\"link\":\"/zh/guide/multithreaded-async\"},{\"text\":\"线程安全函数\",\"link\":\"/zh/guide/tsfn\"},{\"text\":\"常见问题\",\"link\":\"/zh/guide/faq\"}]},{\"text\":\"API\",\"items\":[{\"text\":\"API 列表\",\"link\":\"/zh/reference/list\"},{\"text\":\"额外新增的 API\",\"link\":\"/zh/reference/additional\"}]}]}}}},\"scrollOffset\":\"header\",\"cleanUrls\":false}");</script>
    
  </body>
</html>